(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.Shaku=f()}})(function(){var define,module,exports;return function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r}()({1:[function(require,module,exports){"use strict";class Asset{constructor(url){this._url=url;this._waitingCallbacks=[]}onReady(callback){if(this.valid||this._waitingCallbacks===null){callback();return}this._waitingCallbacks.push(callback)}_notifyReady(){if(this._waitingCallbacks){for(let i=0;i<this._waitingCallbacks.length;++i){this._waitingCallbacks[i]()}this._waitingCallbacks=null}}get url(){return this._url}get valid(){throw new Error("Not Implemented!")}load(params){throw new Error("Not Implemented!")}create(source){throw new Error("Not Supported for this asset type.")}destroy(){throw new Error("Not Implemented!")}}module.exports=Asset},{}],2:[function(require,module,exports){"use strict";const SoundAsset=require("../assets/sound_asset.js");const IManager=require("../manager.js");const BinaryAsset=require("./binary_asset.js");const JsonAsset=require("./json_asset.js");const TextureAsset=require("./texture_asset.js");const FontTextureAsset=require("./font_texture_asset");const Asset=require("./asset.js");const _logger=require("../logger.js").getLogger("assets");class Assets extends IManager{constructor(){super();this._loaded=null;this._waitingAssets=new Set;this._failedAssets=new Set;this._successfulLoadedAssetsCount=0;this.root="";this.suffix=""}_wrapUrl(url){if(!url){return url}return this.root+url+this.suffix}get pendingAssets(){return Array.from(this._waitingAssets)}get failedAssets(){return Array.from(this._failedAssets)}waitForAll(){return new Promise((resolve,reject)=>{_logger.debug("Waiting for all assets..");let checkAssets=()=>{if(this._failedAssets.size!==0){_logger.warn("Dont waiting for assets: had errors.");return reject(this.failedAssets)}if(this._waitingAssets.size===0){_logger.debug("Dont waiting for assets: everything loaded successfully.");return resolve()}setTimeout(checkAssets,1)};checkAssets()})}setup(){return new Promise((resolve,reject)=>{_logger.info("Setup assets manager..");this._loaded={};resolve()})}startFrame(){}endFrame(){}_getFromCache(url,type){let cached=this._loaded[url]||null;if(cached&&type){if(!(cached instanceof type)){throw new Error(`Asset with URL '${url}' is already loaded, but has unexpected type (expecting ${type})!`)}}return cached}async _loadAndCacheAsset(newAsset,params){let url=newAsset.url;let typeName=newAsset.constructor.name;this._loaded[url]=newAsset;this._waitingAssets.add(url);return new Promise(async(resolve,reject)=>{_logger.debug(`Load asset [${typeName}] from URL '${url}'.`);try{await newAsset.load(params)}catch(e){_logger.warn(`Failed to load asset [${typeName}] from URL '${url}'.`);this._failedAssets.add(url);return reject(e)}this._waitingAssets.delete(url);if(!newAsset.valid){_logger.warn(`Failed to load asset [${typeName}] from URL '${url}'.`);this._failedAssets.add(url);return reject("Loaded asset is not valid!")}_logger.debug(`Successfully loaded asset [${typeName}] from URL '${url}'.`);this._successfulLoadedAssetsCount++;resolve(newAsset)})}getCached(url){url=this._wrapUrl(url);return this._loaded[url]||null}_loadAssetType(url,typeClass,params){url=this._wrapUrl(url);let _asset=this._getFromCache(url,typeClass);var needLoad=false;if(!_asset){_asset=new typeClass(url);needLoad=true}let promise=new Promise(async(resolve,reject)=>{if(needLoad){await this._loadAndCacheAsset(_asset,params)}_asset.onReady(()=>{resolve(_asset)})});promise.asset=_asset;return promise}_createAsset(name,classType,initMethod){name=this._wrapUrl(name);var _asset=new classType(name||generateRandomAssetName());let promise=new Promise(async(resolve,reject)=>{if(name&&this._loaded[name]){return reject(`Asset of type '${classType.name}' to create with URL '${name}' already exist in cache!`)}initMethod(_asset);if(name){this._loaded[name]=_asset}resolve(_asset)});promise.asset=_asset;return promise}loadSound(url){return this._loadAssetType(url,SoundAsset,undefined)}loadTexture(url,params){return this._loadAssetType(url,TextureAsset,params)}createRenderTarget(name,width,height){if(!width||!height){return reject("Missing or invalid size!")}return this._createAsset(name,TextureAsset,asset=>{asset.createRenderTarget(width,height)})}loadFontTexture(url,params){return this._loadAssetType(url,FontTextureAsset,params)}loadJson(url){return this._loadAssetType(url,JsonAsset)}createJson(name,data){if(!data){return reject("Missing or invalid data!")}return this._createAsset(name,JsonAsset,asset=>{asset.create(data)})}loadBinary(url){return this._loadAssetType(url,BinaryAsset)}createBinary(name,data){if(!data){return reject("Missing or invalid data!")}return this._createAsset(name,BinaryAsset,asset=>{asset.create(data)})}free(url){url=this._wrapUrl(url);let asset=this._loaded[url];if(asset){asset.destroy();delete this._loaded[url]}}clearCache(){for(let key in this._loaded){this._loaded[key].destroy()}this._loaded={};this._waitingAssets=new Set;this._failedAssets=new Set}destroy(){this.clearCache()}}var _nextRandomAssetId=0;function generateRandomAssetName(){return"_runtime_asset_"+_nextRandomAssetId+++"_"}module.exports=new Assets},{"../assets/sound_asset.js":7,"../logger.js":38,"../manager.js":39,"./asset.js":1,"./binary_asset.js":3,"./font_texture_asset":4,"./json_asset.js":6,"./texture_asset.js":8}],3:[function(require,module,exports){"use strict";const Asset=require("./asset");class BinaryAsset extends Asset{constructor(url){super(url);this._data=null}load(){return new Promise((resolve,reject)=>{var request=new XMLHttpRequest;request.open("GET",this.url,true);request.responseType="arraybuffer";request.onload=(()=>{if(request.readyState==4){if(request.response){this._data=new Uint8Array(request.response);this._notifyReady();resolve()}else{reject(request.statusText)}}});request.onerror=(e=>{reject(e)});request.send()})}create(source){return new Promise((resolve,reject)=>{if(source instanceof Array){source=new Uint8Array(source)}if(!(source instanceof Uint8Array)){return reject("Binary asset source must be of type 'Uint8Array'!")}this._data=source;this._notifyReady();resolve()})}get valid(){return Boolean(this._data)}destroy(){this._data=null}get data(){return this._data}string(){return(new TextDecoder).decode(this._data)}}module.exports=BinaryAsset},{"./asset":1}],4:[function(require,module,exports){"use strict";const Asset=require("./asset");const Vector2=require("../utils/vector2");const Rectangle=require("../utils/rectangle");const TextureAsset=require("./texture_asset");class FontTextureAsset extends Asset{constructor(url){super(url);this._fontName=null;this._fontSize=null;this._placeholderChar=null;this._sourceRects=null;this._texture=null;this._lineHeight=0}get lineHeight(){return this._lineHeight}get fontName(){return this._fontName}get fontSize(){return this._fontSize}get placeholderCharacter(){return this._placeholderChar}get texture(){return this._texture}load(params){return new Promise(async(resolve,reject)=>{if(!params||!params.fontName){return reject("When loading font texture you must provide params with a 'fontName' value!")}this._placeholderChar=(params.missingCharPlaceholder||"?")[0];let smooth=params.smoothFont===undefined?true:params.smoothFont;let maxTextureWidth=params.maxTextureWidth||1024;let charsSet=params.charactersSet||FontTextureAsset.defaultCharactersSet;if(charsSet.indexOf(this._placeholderChar)===-1){charsSet+=this._placeholderChar}let fontFace=new FontFace(params.fontName,`url(${this.url})`);await fontFace.load();document.fonts.add(fontFace);this._fontName=params.fontName;this._fontSize=params.fontSize||52;let margin={x:10,y:5};let fontFullName=this.fontSize.toString()+"px "+this.fontName;let fontHeight=measureTextHeight(this.fontName,this.fontSize);let fontWidth=measureTextWidth(this.fontName,this.fontSize);this._lineHeight=fontHeight;let estimatedCharSizeInTexture=new Vector2(fontWidth+margin.x*2,fontHeight+margin.y*2);let charsPerRow=Math.floor(maxTextureWidth/estimatedCharSizeInTexture.x);let textureWidth=Math.min(charsSet.length*estimatedCharSizeInTexture.x,maxTextureWidth);let textureHeight=Math.ceil(charsSet.length/charsPerRow)*estimatedCharSizeInTexture.y;if(params.enforceTexturePowerOfTwo||params.enforceTexturePowerOfTwo===undefined){textureWidth=makePowerTwo(textureWidth);textureHeight=makePowerTwo(textureHeight)}this._sourceRects={};let canvas=document.createElement("canvas");canvas.width=textureWidth;canvas.height=textureHeight;if(!smooth){canvas.style.webkitFontSmoothing="none";canvas.style.fontSmooth="never";canvas.style.textRendering="geometricPrecision"}let ctx=canvas.getContext("2d");ctx.font=fontFullName;ctx.fillStyle="#ffffffff";ctx.imageSmoothingEnabled=smooth;let x=0;let y=0;for(let i=0;i<charsSet.length;++i){let currChar=charsSet[i];let currCharWidth=Math.ceil(ctx.measureText(currChar).width);if(x+currCharWidth>textureWidth){y+=Math.round(fontHeight+margin.y);x=0}let sourceRect=new Rectangle(x,y+Math.round(fontHeight/4),currCharWidth,fontHeight);this._sourceRects[currChar]=sourceRect;ctx.fillText(currChar,x,y+fontHeight);x+=Math.round(currCharWidth+margin.x)}if(!smooth){let imageData=ctx.getImageData(0,0,ctx.canvas.width,ctx.canvas.height);let data=imageData.data;for(let i=0;i<data.length;i+=4){if(data[i+3]>0&&(data[i+3]<255||data[i]<255||data[i+1]<255||data[i+2]<255)){data[i+3]=0}}ctx.putImageData(imageData,0,0)}let img=new Image;img.src=canvas.toDataURL("image/png");img.onload=(()=>{let texture=new TextureAsset(this.url+"__font-texture");texture.fromImage(img);this._texture=texture;this._notifyReady();resolve()})})}get valid(){return Boolean(this._texture)}getSourceRect(character){return this._sourceRects[character]||this._sourceRects[this.placeholderCharacter]}destroy(){if(this._texture)this._texture.destroy();this._fontName=null;this._fontSize=null;this._placeholderChar=null;this._sourceRects=null;this._texture=null;this._lineHeight=0}}FontTextureAsset.defaultCharactersSet=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_`abcdefghijklmnopqrstuvwxyz{|}~ ¡¢£¤¥¦§¨©ª«¬­®¯°±²³´µ¶·¸¹º»¼½¾";function makePowerTwo(val){let ret=2;while(ret<val){if(ret>=val){return ret}ret=ret*2}return ret}function measureTextHeight(fontFamily,fontSize,char){let text=document.createElement("pre");text.style.fontFamily=fontFamily;text.style.fontSize=fontSize+"px";text.style.paddingBottom=text.style.paddingLeft=text.style.paddingTop=text.style.paddingRight="0px";text.style.marginBottom=text.style.marginLeft=text.style.marginTop=text.style.marginRight="0px";text.textContent=char||"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 ";document.body.appendChild(text);let result=text.getBoundingClientRect().height;document.body.removeChild(text);return Math.ceil(result)}function measureTextWidth(fontFamily,fontSize,char){if(char==="\n"||char==="\r"){return 0}let canvas=document.createElement("canvas");let context=canvas.getContext("2d");context.font=fontSize.toString()+"px "+fontFamily;let result=0;let text=char||"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 ";for(let i=0;i<text.length;++i){result=Math.max(result,context.measureText(text[i]).width)}return Math.ceil(result)}module.exports=FontTextureAsset},{"../utils/rectangle":51,"../utils/vector2":53,"./asset":1,"./texture_asset":8}],5:[function(require,module,exports){"use strict";module.exports=require("./assets")},{"./assets":2}],6:[function(require,module,exports){"use strict";const Asset=require("./asset");class JsonAsset extends Asset{constructor(url){super(url);this._data=null}load(){return new Promise((resolve,reject)=>{var request=new XMLHttpRequest;request.open("GET",this.url,true);request.responseType="json";request.onload=(()=>{if(request.readyState==4){if(request.response){this._data=request.response;this._notifyReady();resolve()}else{if(request.status===200){reject("Response is not a valid JSON!")}else{reject(request.statusText)}}}});request.onerror=(e=>{reject(e)});request.send()})}create(source){return new Promise((resolve,reject)=>{try{if(source){if(typeof source==="string"){source=JSON.parse(source)}else{source=JSON.parse(JSON.stringify(source))}}else{source={}}}catch(e){return reject("Data is not a valid JSON serializable object!")}this._data=source;this._notifyReady();resolve()})}get data(){return this._data}get valid(){return Boolean(this._data)}destroy(){this._data=null}}module.exports=JsonAsset},{"./asset":1}],7:[function(require,module,exports){"use strict";const Asset=require("./asset");class SoundAsset extends Asset{constructor(url){super(url);this._valid=false}load(){return new Promise((resolve,reject)=>{let audioCtx=new(window.AudioContext||window.webkitAudioContext);var request=new XMLHttpRequest;request.open("GET",this.url,true);request.responseType="arraybuffer";request.onload=(()=>{var audioData=request.response;this._valid=true;this._notifyReady();audioCtx.decodeAudioData(audioData,function(buffer){resolve()},e=>{reject(e.err)})});request.onerror=(e=>{reject(e)});request.send()})}get valid(){return this._valid}destroy(){this._valid=false}}module.exports=SoundAsset},{"./asset":1}],8:[function(require,module,exports){"use strict";const Asset=require("./asset");const TextureFilterModes=require("../gfx/texture_filter_modes");const TextureWrapModes=require("../gfx/texture_wrap_modes");const Color=require("../utils/color");const Vector2=require("../utils/vector2");const _logger=require("../logger.js").getLogger("assets");var gl=null;class TextureAsset extends Asset{constructor(url){super(url);this._image=null;this._width=0;this._height=0;this._texture=null;this._filter=null;this._wrapMode=null;this._ctxForPixelData=null}static _setWebGl(_gl){gl=_gl}get filter(){return this._filter}set filter(value){this._filter=value}get wrapMode(){return this._wrapMode}set wrapMode(value){this._wrapMode=value}load(params){params=params||{};return new Promise((resolve,reject)=>{if(!gl){return reject("Can't load textures before initializing gfx manager!")}const image=new Image;image.onload=(async()=>{try{await this.create(image,params);this._notifyReady();resolve()}catch(e){reject(e)}});image.onerror=(()=>{reject("Failed to load texture image!")});image.src=this.url})}createRenderTarget(width,height){const targetTextureWidth=width;const targetTextureHeight=height;const targetTexture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,targetTexture);{const level=0;const internalFormat=gl.RGBA;const border=0;const format=gl.RGBA;const type=gl.UNSIGNED_BYTE;const data=null;gl.texImage2D(gl.TEXTURE_2D,level,internalFormat,targetTextureWidth,targetTextureHeight,border,format,type,data);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE)}this._width=width;this._height=height;this._texture=targetTexture;this._notifyReady()}fromImage(image,params){if(image.width===0){throw new Error("Image to build texture from must be loaded and have valid size!")}if(this.valid){throw new Error("Texture asset is already initialized!")}params=params||{};this._image=image;this._width=image.width;this._height=image.height;const texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture);const level=0;const internalFormat=gl.RGBA;const srcFormat=gl.RGBA;const srcType=gl.UNSIGNED_BYTE;gl.bindTexture(gl.TEXTURE_2D,texture);gl.texImage2D(gl.TEXTURE_2D,level,internalFormat,srcFormat,srcType,image);if(params.generateMipMaps){if(isPowerOf2(image.width)&&isPowerOf2(image.height)){_logger.warn("Tried to generate MipMaps for a texture with size that is *not* a power of two. This might not work as expected.")}gl.generateMipmap(gl.TEXTURE_2D)}gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);this._texture=texture;this._notifyReady()}create(source,params){return new Promise(async(resolve,reject)=>{if(typeof source==="string"){let img=new Image;img.onload=(()=>{this.fromImage(source,params);this._notifyReady();resolve()});img.src=source}else{this.fromImage(source,params);resolve()}})}get image(){return this._image}get width(){return this._width}get height(){return this._height}get size(){return new Vector2(this.width,this.height)}get texture(){return this._texture}getPixel(x,y){if(!this._image){throw new Error("'getPixel()' only works on textures loaded from image!")}if(!this._ctxForPixelData){let canvas=document.createElement("canvas");canvas.width=1;canvas.height=1;this._ctxForPixelData=canvas.getContext("2d")}let ctx=this._ctxForPixelData;ctx.drawImage(this._image,x,y,1,1,0,0,1,1);let pixelData=ctx.getImageData(0,0,1,1).data;return Color.fromBytesArray(pixelData)}get valid(){return Boolean(this._texture)}destroy(){gl.deleteTexture(this._texture);this._image=null;this._width=this._height=0;this._ctxForPixelData=null;this._texture=null}}function isPowerOf2(value){return(value&value-1)==0}module.exports=TextureAsset},{"../gfx/texture_filter_modes":32,"../gfx/texture_wrap_modes":33,"../logger.js":38,"../utils/color":47,"../utils/vector2":53,"./asset":1}],9:[function(require,module,exports){"use strict";const IManager=require("../manager.js");const Vector2=require("../utils/vector2.js");const CollisionWorld=require("./collision_world.js");const CollisionResolver=require("./resolver");const CircleShape=require("./shapes/circle.js");const PointShape=require("./shapes/point.js");const RectangleShape=require("./shapes/rectangle.js");const ResolverImp=require("./resolvers_imp");const _logger=require("../logger.js").getLogger("collision");class Collision extends IManager{constructor(){super();this.resolver=new CollisionResolver}setup(){return new Promise((resolve,reject)=>{_logger.info("Setup collision manager..");this.resolver._init();this.resolver.setHandler(PointShape,PointShape,ResolverImp.pointPoint);this.resolver.setHandler(PointShape,CircleShape,ResolverImp.pointCircle);this.resolver.setHandler(PointShape,RectangleShape,ResolverImp.pointRectangle);this.resolver.setHandler(CircleShape,CircleShape,ResolverImp.circleCircle);this.resolver.setHandler(CircleShape,RectangleShape,ResolverImp.circleRectangle);this.resolver.setHandler(RectangleShape,RectangleShape,ResolverImp.rectangleRectangle);resolve()})}createWorld(gridCellSize){return new CollisionWorld(this.resolver,gridCellSize)}get RectangleShape(){return RectangleShape}get PointShape(){return PointShape}get CircleShape(){return CircleShape}startFrame(){}endFrame(){}destroy(){}}module.exports=new Collision},{"../logger.js":38,"../manager.js":39,"../utils/vector2.js":53,"./collision_world.js":10,"./resolver":12,"./resolvers_imp":13,"./shapes/circle.js":15,"./shapes/point.js":16,"./shapes/rectangle.js":17}],10:[function(require,module,exports){"use strict";const Color=require("../utils/color");const Vector2=require("../utils/vector2");const Circle=require("../utils/circle");const CollisionTestResult=require("./result");const CollisionShape=require("./shapes/shape");const gfx=require("./../gfx");const Rectangle=require("../utils/rectangle");const CollisionResolver=require("./resolver");const PointShape=require("./shapes/point");const CircleShape=require("./shapes/circle");const _logger=require("../logger.js").getLogger("collision");class CollisionWorld{constructor(resolver,gridCellSize){this.resolver=resolver;if(typeof gridCellSize==="undefined"){gridCellSize=new Vector2(512,512)}else if(typeof gridCellSize==="number"){gridCellSize=new Vector2(gridCellSize,gridCellSize)}else{gridCellSize=gridCellSize.clone()}this._gridCellSize=gridCellSize;this._grid={};this._shapesToUpdate=new Set;this._cellsToDelete=new Set}_performUpdates(){if(this._cellsToDelete.size>0){for(let key of this._cellsToDelete){if(this._grid[key]&&this._grid[key].size===0){delete this._grid[key]}}this._cellsToDelete.clear()}if(this._shapesToUpdate.size>0){for(let shape of this._shapesToUpdate){this._updateShape(shape)}this._shapesToUpdate.clear()}}_updateShape(shape){if(shape._world!==this){return}let bb=shape._getBoundingBox();let minx=Math.floor(bb.left/this._gridCellSize.x);let miny=Math.floor(bb.top/this._gridCellSize.y);let maxx=Math.ceil(bb.right/this._gridCellSize.x);let maxy=Math.ceil(bb.bottom/this._gridCellSize.y);if(shape._worldRange){if(shape._worldRange[0]===minx&&shape._worldRange[1]===miny&&shape._worldRange[2]===maxx&&shape._worldRange[3]===maxy){return}let ominx=shape._worldRange[0];let ominy=shape._worldRange[1];let omaxx=shape._worldRange[2];let omaxy=shape._worldRange[3];for(let i=ominx;i<omaxx;++i){for(let j=ominy;j<omaxy;++j){if(i>=minx&&i<maxx&&j>=miny&&j<maxy){continue}let key=i+","+j;let currSet=this._grid[key];if(currSet){currSet.delete(shape);if(currSet.size===0){this._cellsToDelete.add(key)}}}}}for(let i=minx;i<maxx;++i){for(let j=miny;j<maxy;++j){let key=i+","+j;let currSet=this._grid[key];if(!currSet){this._grid[key]=currSet=new Set}currSet.add(shape)}}shape._worldRange=[minx,miny,maxx,maxy]}_queueUpdate(shape){this._shapesToUpdate.add(shape)}addShape(shape){shape._setParent(this);this._updateShape(shape);this._performUpdates()}removeShape(shape){if(shape._world!==this){_logger.warn("Shape to remove is not in this collision world!");return}if(shape._worldRange){let minx=shape._worldRange[0];let miny=shape._worldRange[1];let maxx=shape._worldRange[2];let maxy=shape._worldRange[3];for(let i=minx;i<maxx;++i){for(let j=miny;j<maxy;++j){let key=i+","+j;let currSet=this._grid[key];if(currSet){currSet.delete(shape);if(currSet.size===0){this._cellsToDelete.add(key)}}}}}this._updateShape.delete(shape);shape._setParent(null);this._performUpdates()}_iterateBroadPhase(shape,handler,mask,predicate){let bb=shape._getBoundingBox();let minx=Math.floor(bb.left/this._gridCellSize.x);let miny=Math.floor(bb.top/this._gridCellSize.y);let maxx=Math.ceil(bb.right/this._gridCellSize.x);let maxy=Math.ceil(bb.bottom/this._gridCellSize.y);let checked=new Set;for(let i=minx;i<maxx;++i){for(let j=miny;j<maxy;++j){let key=i+","+j;let currSet=this._grid[key];if(currSet){for(let other of currSet){if(mask&&(other.collisionFlags&mask)===0){continue}if(checked.has(other)){continue}checked.add(other);if(other===shape){continue}if(predicate&&!predicate(other)){continue}let proceedLoop=Boolean(handler(other));if(!proceedLoop){return}}}}}}testCollision(sourceShape,sortByDistance,mask,predicate){this._performUpdates();var result=null;if(sortByDistance){var options=[];this._iterateBroadPhase(sourceShape,other=>{options.push(other);return true},mask,predicate);sortByDistanceShapes(sourceShape,options);for(let i=0;i<options.length;++i){result=this.resolver.test(sourceShape,options[i]);if(result){break}}}else{this._iterateBroadPhase(sourceShape,other=>{result=this.resolver.test(sourceShape,other);return!result},mask,predicate)}return result}testCollisionMany(sourceShape,sortByDistance,mask,predicate){this._performUpdates();var ret=[];this._iterateBroadPhase(sourceShape,other=>{let result=this.resolver.test(sourceShape,other);if(result){ret.push(result)}return true},mask,predicate);if(sortByDistance){sortByDistanceResults(sourceShape,ret)}return ret}pick(position,radius,sortByDistance,mask,predicate){let shape=(radius||0)<=1?new PointShape(position):new CircleShape(new Circle(position,radius));let ret=this.testCollisionMany(shape,sortByDistance,mask,predicate);return ret.map(x=>x.second)}debugDraw(gridColor,gridHighlitColor,opacity,camera){this._performUpdates();if(!gridColor){gridColor=Color.black;gridColor.a*=.75}if(!gridHighlitColor){gridHighlitColor=Color.red;gridHighlitColor.a*=.75}if(opacity===undefined){opacity=.5}gridColor.a*=opacity;gridHighlitColor.a*=opacity;let renderedShapes=new Set;let bb=camera?camera.getRegion():gfx.getRenderingRegion(false);let minx=Math.floor(bb.left/this._gridCellSize.x);let miny=Math.floor(bb.top/this._gridCellSize.y);let maxx=minx+Math.ceil(bb.width/this._gridCellSize.x);let maxy=miny+Math.ceil(bb.height/this._gridCellSize.y);for(let i=minx;i<=maxx;++i){for(let j=miny;j<=maxy;++j){let cell=this._grid[i+","+j];let color=cell&&cell.size?gridHighlitColor:gridColor;let cellRect=new Rectangle(i*this._gridCellSize.x,j*this._gridCellSize.y,this._gridCellSize.x-1,this._gridCellSize.y-1);gfx.outlineRect(cellRect,color,gfx.BlendModes.AlphaBlend,0);if(cell){for(let shape of cell){if(renderedShapes.has(shape)){continue}renderedShapes.add(shape);shape.debugDraw(opacity)}}}}}}function sortByDistanceShapes(sourceShape,options){let sourceCenter=sourceShape.getCenter();options.sort((a,b)=>a.getCenter().distanceTo(sourceCenter)-a._getRadius()-(b.getCenter().distanceTo(sourceCenter)-b._getRadius()))}function sortByDistanceResults(sourceShape,options){let sourceCenter=sourceShape.getCenter();options.sort((a,b)=>a.second.getCenter().distanceTo(sourceCenter)-a.second._getRadius()-(b.second.getCenter().distanceTo(sourceCenter)-b.second._getRadius()))}module.exports=CollisionWorld},{"../logger.js":38,"../utils/circle":46,"../utils/color":47,"../utils/rectangle":51,"../utils/vector2":53,"./../gfx":25,"./resolver":12,"./result":14,"./shapes/circle":15,"./shapes/point":16,"./shapes/shape":18}],11:[function(require,module,exports){"use strict";module.exports=require("./collision")},{"./collision":9}],12:[function(require,module,exports){"use strict";const Vector2=require("../utils/vector2.js");const CollisionTestResult=require("./result.js");const CollisionShape=require("./shapes/shape.js");const _logger=require("../logger.js").getLogger("collision");class CollisionResolver{constructor(){this._handlers={}}_init(){}setHandler(firstShapeClass,secondShapeClass,handler){_logger.debug(`Register handler for shapes '${firstShapeClass.name}' and '${secondShapeClass.name}'.`);if(!this._handlers[firstShapeClass]){this._handlers[firstShapeClass]={}}this._handlers[firstShapeClass][secondShapeClass]=handler;if(!this._handlers[secondShapeClass]){this._handlers[secondShapeClass]={}}this._handlers[secondShapeClass][firstShapeClass]=((f,s)=>{return handler(s,f)})}test(first,second){let handler=this._getCollisionMethod(first,second);if(!handler){_logger.warn(`Missing collision handler for shapes '${first.constructor.name}' and '${second.constructor.name}'.`);return null}let result=handler(first,second);if(result){let position=result instanceof Vector2?result:null;return new CollisionTestResult(position,first,second)}return null}_getCollisionMethod(first,second){if(this._handlers[first.constructor]){return this._handlers[first.constructor][second.constructor]||null}return null}}module.exports=CollisionResolver},{"../logger.js":38,"../utils/vector2.js":53,"./result.js":14,"./shapes/shape.js":18}],13:[function(require,module,exports){"use strict";module.exports={pointPoint:function(v1,v2){return v1._position.approximate(v2._position)?v1._position:false},pointCircle:function(v1,c1){return v1._position.distanceTo(c1._circle.center)<=c1._circle.radius?v1._position:false},pointRectangle:function(v1,r1){return r1._rect.containsVector(v1._position)?v1._position:false},circleCircle:function(c1,c2){return c1._circle.center.distanceTo(c2._circle.center)<=c1._circle.radius+c2._circle.radius},circleRectangle:function(c1,r1){return r1._rect.collideCircle(c1._circle)},rectangleRectangle:function(r1,r2){return r1._rect.collideRect(r2._rect)}}},{}],14:[function(require,module,exports){"use strict";const Vector2=require("../utils/vector2");const CollisionShape=require("./shapes/shape");class CollisionTestResult{constructor(position,first,second){this.position=position;this.first=first;this.second=second}}module.exports=CollisionTestResult},{"../utils/vector2":53,"./shapes/shape":18}],15:[function(require,module,exports){"use strict";const CollisionShape=require("./shape");const gfx=require("./../../gfx");const Circle=require("../../utils/circle");const Rectangle=require("../../utils/rectangle");class CircleShape extends CollisionShape{constructor(circle){super();this.setShape(circle)}setShape(circle){this._circle=circle;this._position=circle.center;this._boundingBox=new Rectangle(circle.center.x-circle.radius,circle.center.y-circle.radius,circle.radius*2,circle.radius*2);this._shapeChanged()}_getRadius(){return this._circle.radius}getCenter(){return this._position.clone()}_getBoundingBox(){return this._boundingBox}debugDraw(opacity){if(opacity===undefined)opacity=1;let color=this._getDebugColor();color.a*=opacity;gfx.outlineCircle(this._circle,color,gfx.BlendModes.AlphaBlend,14);color.a*=.25;gfx.fillCircle(this._circle,color,gfx.BlendModes.AlphaBlend,14)}}module.exports=CircleShape},{"../../utils/circle":46,"../../utils/rectangle":51,"./../../gfx":25,"./shape":18}],16:[function(require,module,exports){"use strict";const CollisionShape=require("./shape");const gfx=require("./../../gfx");const Vector2=require("../../utils/vector2");const Rectangle=require("../../utils/rectangle");const Circle=require("../../utils/circle");class PointShape extends CollisionShape{constructor(position){super();this.setPosition(position)}setPosition(position){this._position=position.clone();this._boundingBox=new Rectangle(position.x,position.y,1,1);this._shapeChanged()}getPosition(){return this._position.clone()}getCenter(){return this._position.clone()}_getRadius(){return 1}_getBoundingBox(){return this._boundingBox}debugDraw(opacity){if(opacity===undefined)opacity=1;let color=this._getDebugColor();color.a*=opacity;gfx.outlineCircle(new Circle(this.getPosition(),3),color,gfx.BlendModes.AlphaBlend,4)}}module.exports=PointShape},{"../../utils/circle":46,"../../utils/rectangle":51,"../../utils/vector2":53,"./../../gfx":25,"./shape":18}],17:[function(require,module,exports){"use strict";const Rectangle=require("../../utils/rectangle");const CollisionShape=require("./shape");const gfx=require("./../../gfx");class RectangleShape extends CollisionShape{constructor(rectangle){super();this.setShape(rectangle)}setShape(rectangle){this._rect=rectangle;this._center=rectangle.getCenter();this._radius=(this._rect.width/2+this._rect.height/2)/2;this._shapeChanged()}_getRadius(){return this._radius}_getBoundingBox(){return this._rect}getCenter(){return this._center.clone()}debugDraw(opacity){if(opacity===undefined)opacity=1;let color=this._getDebugColor();color.a*=opacity;gfx.outlineRect(this._rect,color,gfx.BlendModes.AlphaBlend);color.a*=.25;gfx.fillRect(this._rect,color,gfx.BlendModes.AlphaBlend)}}module.exports=RectangleShape},{"../../utils/rectangle":51,"./../../gfx":25,"./shape":18}],18:[function(require,module,exports){"use strict";const Color=require("../../utils/color");const Rectangle=require("../../utils/rectangle");const Vector2=require("../../utils/vector2");const CollisionWorld=require("../collision_world");class CollisionShape{constructor(){this._world=null;this._worldRange=null;this._debugColor=null;this._forceDebugColor=null;this._collisionFlags=Number.MAX_SAFE_INTEGER}get collisionFlags(){return this._collisionFlags}set collisionFlags(value){this._debugColor=null;this._collisionFlags=value;return this._collisionFlags}setDebugColor(color){this._forceDebugColor=color}debugDraw(opacity){throw new Error("Not Implemented!")}getCenter(){throw new Error("Not Implemented!")}_getDebugColor(){if(this._forceDebugColor){return this._forceDebugColor.clone()}if(!this._debugColor){this._debugColor=defaultDebugColors[this.collisionFlags%defaultDebugColors.length]}return this._debugColor.clone()}_getRadius(){throw new Error("Not Implemented!")}_getBoundingBox(){throw new Error("Not Implemented!")}_setParent(world){if(world===this._world){return}if(this._world&&world){throw new Error("Cannot add collision shape to world while its already in another world!")}this._world=world;this._worldRange=null}_shapeChanged(){if(this._world){this._world._queueUpdate(this)}}}const defaultDebugColors=[Color.red,Color.blue,Color.green,Color.yellow,Color.purple,Color.teal,Color.brown,Color.orange,Color.khaki,Color.darkcyan,Color.cornflowerblue,Color.darkgray,Color.chocolate,Color.aquamarine,Color.cadetblue,Color.magenta,Color.seagreen,Color.pink,Color.olive,Color.violet];module.exports=CollisionShape},{"../../utils/color":47,"../../utils/rectangle":51,"../../utils/vector2":53,"../collision_world":10}],19:[function(require,module,exports){"use strict";const BlendModes={AlphaBlend:"alpha",Opaque:"opaque",Additive:"additive",Multiply:"multiply",Subtract:"subtract",Screen:"screen",Overlay:"overlay",Invert:"invert",Darken:"darken",DestIn:"dest-in",DestOut:"dest-out"};Object.defineProperty(BlendModes,"_values",{value:new Set(Object.values(BlendModes)),writable:false});Object.freeze(BlendModes);module.exports=BlendModes},{}],20:[function(require,module,exports){"use strict";const Rectangle=require("../utils/rectangle");const Vector2=require("../utils/vector2");const Matrix=require("./matrix");class Camera{constructor(gfx){this.projection=null;this._region=null;this._gfx=gfx;this.orthographic();this._viewport=null}get viewport(){return this._viewport}set viewport(viewport){this._viewport=viewport;return viewport}getRegion(){return this._region.clone()}orthographicOffset(offset,ignoreViewportSize,near,far){let renderingSize=ignoreViewportSize||!this.viewport?this._gfx.getCanvasSize():this.viewport.getSize();let region=new Rectangle(offset.x,offset.y,renderingSize.x,renderingSize.y);this.orthographic(region,near,far)}orthographic(region,near,far){if(region===undefined){region=this._gfx.getRenderingRegion()}this._region=region;this.projection=Matrix.orthographic(region.left,region.right,region.bottom,region.top,near||-1,far||400)}_perspective(fieldOfView,aspectRatio,near,far){this.projection=Matrix.perspective(fieldOfView||Math.PI/2,aspectRatio||1,near||.1,far||1e3)}}module.exports=Camera},{"../utils/rectangle":51,"../utils/vector2":53,"./matrix":26}],21:[function(require,module,exports){"use strict";const Effect=require("./effect");const vertexShader=`\nattribute vec3 position;\nattribute vec2 coord;\nattribute vec4 color;\n\nuniform mat4 projection;\nuniform mat4 world;\n\nuniform vec2 uvOffset;\nuniform vec2 uvScale;\n\nvarying vec2 v_texCoord;\nvarying vec4 v_color;\n\nvoid main(void) {\n    gl_Position = projection * world * vec4(position, 1.0);\n    v_texCoord = uvOffset + (coord * uvScale);\n    v_color = color;\n}\n    `;const fragmentShader=`  \n#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D texture;\n\nvarying vec2 v_texCoord;\nvarying vec4 v_color;\n\nvoid main(void) {\n    gl_FragColor = texture2D(texture, v_texCoord) * v_color;\n    gl_FragColor.rgb *= gl_FragColor.a;\n}\n    `;class BasicEffect extends Effect{get vertexCode(){return vertexShader}get fragmentCode(){return fragmentShader}get uniformTypes(){return{texture:{type:Effect.UniformTypes.Texture,bind:Effect.UniformBinds.MainTexture},projection:{type:Effect.UniformTypes.Matrix,bind:Effect.UniformBinds.Projection},world:{type:Effect.UniformTypes.Matrix,bind:Effect.UniformBinds.World},uvOffset:{type:Effect.UniformTypes.Float2,bind:Effect.UniformBinds.UvOffset},uvScale:{type:Effect.UniformTypes.Float2,bind:Effect.UniformBinds.UvScale}}}get attributeTypes(){return{position:{size:3,type:Effect.AttributeTypes.Float,normalize:false,bind:Effect.AttributeBinds.Position},coord:{size:2,type:Effect.AttributeTypes.Float,normalize:false,bind:Effect.AttributeBinds.TextureCoords},color:{size:4,type:Effect.AttributeTypes.Float,normalize:false,bind:Effect.AttributeBinds.Colors}}}}module.exports=BasicEffect},{"./effect":22}],22:[function(require,module,exports){"use strict";const TextureAsset=require("../../assets/texture_asset.js");const Color=require("../../utils/color.js");const Rectangle=require("../../utils/rectangle.js");const Matrix=require("../matrix.js");const _logger=require("../../logger.js").getLogger("gfx-effect");class Effect{_build(gl){let program=gl.createProgram();{let shader=compileShader(gl,this.vertexCode,gl.VERTEX_SHADER);gl.attachShader(program,shader)}{let shader=compileShader(gl,this.fragmentCode,gl.FRAGMENT_SHADER);gl.attachShader(program,shader)}gl.linkProgram(program);if(!gl.getProgramParameter(program,gl.LINK_STATUS)){_logger.error("Error linking shader program:");_logger.error(gl.getProgramInfoLog(program));throw new Error("Failed to link shader program.")}this._gl=gl;this._program=program;this.uniforms={};this._uniformBinds={};for(let uniform in this.uniformTypes){let uniformLocation=this._gl.getUniformLocation(this._program,uniform);if(uniformLocation===-1){_logger.error("Could not find uniform: "+uniform);throw new Error(`Uniform named '${uniform}' was not found in shader code!`)}let uniformData=this.uniformTypes[uniform];if(!UniformTypes._values.has(uniformData.type)){_logger.error("Uniform has invalid type: "+uniformData.type);throw new Error(`Uniform '${uniform}' have illegal value type '${uniformData.type}'!`)}if(uniformData.type===UniformTypes.Matrix){(function(_this,name,location,method){_this.uniforms[name]=(mat=>{_this._gl[method](location,false,mat)})})(this,uniform,uniformLocation,uniformData.type)}else{(function(_this,name,location,method){_this.uniforms[name]=((v1,v2,v3,v4)=>{_this._gl[method](location,v1,v2,v3,v4)})})(this,uniform,uniformLocation,uniformData.type)}let bindTo=uniformData.bind;if(bindTo){this._uniformBinds[bindTo]=uniform}}this.attributes={};this._attributeBinds={};for(let attr in this.attributeTypes){let attributeLocation=this._gl.getAttribLocation(this._program,attr);if(attributeLocation===-1){_logger.error("Could not find attribute: "+attr);throw new Error(`Attribute named '${attr}' was not found in shader code!`)}let attributeData=this.attributeTypes[attr];(function(_this,name,location,data){_this.attributes[name]=(buffer=>{if(buffer){_this._gl.bindBuffer(_this._gl.ARRAY_BUFFER,buffer);_this._gl.vertexAttribPointer(location,data.size,_this._gl[data.type]||_this._gl.FLOAT,data.normalize||false,data.stride||0,data.offset||0);_this._gl.enableVertexAttribArray(location)}else{_this._gl.disableVertexAttribArray(location)}})})(this,attr,attributeLocation,attributeData);let bindTo=attributeData.bind;if(bindTo){this._attributeBinds[bindTo]=attr}}this._cachedValues={}}get uniformTypes(){throw new Error("Not Implemented!")}get attributeTypes(){throw new Error("Not Implemented!")}setAsActive(){this._gl.useProgram(this._program);if(this.enableDepthTest){this._gl.enable(gl.DEPTH_TEST)}else{this._gl.disable(this._gl.DEPTH_TEST)}if(this.enableFaceCulling){this._gl.enable(gl.CULL_FACE)}else{this._gl.disable(this._gl.CULL_FACE)}if(this.enableStencilTest){this._gl.enable(gl.STENCIL_TEST)}else{this._gl.disable(this._gl.STENCIL_TEST)}this._cachedValues={}}prepareToDraw(mesh,color,world,sourceRect,texture){this.setPositionsAttribute(mesh.positions);this.setTextureCoordsAttribute(mesh.textureCoords);this.setColorsAttribute(mesh.colors);this.setColor(color||Color.white);this.setWorldMatrix(world);this.setUvOffsetAndScale(sourceRect,texture)}prepareToDrawBatch(mesh,world){this._cachedValues={};this.setPositionsAttribute(mesh.positions);this.setTextureCoordsAttribute(mesh.textureCoords);this.setColorsAttribute(mesh.colors);this.setWorldMatrix(world);this.resetUvOffsetAndScale()}resetUvOffsetAndScale(){let uvOffset=this._uniformBinds[Effect.UniformBinds.UvOffset];if(uvOffset){this.uniforms[uvOffset](0,0)}let uvScale=this._uniformBinds[Effect.UniformBinds.UvScale];if(uvScale){this.uniforms[uvScale](1,1)}this._cachedValues.sourceRect=null}get vertexCode(){throw new Error("Not Implemented!")}get fragmentCode(){throw new Error("Not Implemented!")}get enableDepthTest(){return false}get enableFaceCulling(){return false}get enableStencilTest(){return false}setTexture(texture){let uniform=this._uniformBinds[Effect.UniformBinds.MainTexture];if(uniform){if(texture===this._cachedValues.texture){return false}this._cachedValues.texture=texture;let glTexture=texture.texture||texture;this._gl.activeTexture(this._gl.TEXTURE0);this._gl.bindTexture(this._gl.TEXTURE_2D,glTexture);this.uniforms[uniform](glTexture);return true}return false}setColor(color){let uniform=this._uniformBinds[Effect.UniformBinds.Color];if(uniform){if(color.equals(this._cachedValues.color)){return}this._cachedValues.color=color.clone();this.uniforms[uniform](color.floatArray)}}setUvOffsetAndScale(sourceRect,texture){if(sourceRect){if(sourceRect.equals(this._cachedValues.sourceRect)){return}}else{if(this._cachedValues.sourceRect===null){return}}this._cachedValues.sourceRect=sourceRect?sourceRect.clone():null;if(!sourceRect){sourceRect=new Rectangle(0,0,texture.width,texture.height)}let uvOffset=this._uniformBinds[Effect.UniformBinds.UvOffset];if(uvOffset){this.uniforms[uvOffset](sourceRect.x/texture.width,sourceRect.y/texture.height)}let uvScale=this._uniformBinds[Effect.UniformBinds.UvScale];if(uvScale){this.uniforms[uvScale](sourceRect.width/texture.width,sourceRect.height/texture.height)}}setProjectionMatrix(matrix){let uniform=this._uniformBinds[Effect.UniformBinds.Projection];if(uniform){if(matrix.equals(this._cachedValues.projection)){return}this._cachedValues.projection=matrix.clone();this.uniforms[uniform](matrix.values)}}setWorldMatrix(matrix){let uniform=this._uniformBinds[Effect.UniformBinds.World];if(uniform){this.uniforms[uniform](matrix.values)}}setPositionsAttribute(buffer){let attr=this._attributeBinds[Effect.AttributeBinds.Position];if(attr){if(buffer===this._cachedValues.positions){return}this._cachedValues.positions=buffer;this.attributes[attr](buffer)}}setTextureCoordsAttribute(buffer){let attr=this._attributeBinds[Effect.AttributeBinds.TextureCoords];if(attr){if(buffer===this._cachedValues.coords){return}this._cachedValues.coords=buffer;this.attributes[attr](buffer)}}setColorsAttribute(buffer){let attr=this._attributeBinds[Effect.AttributeBinds.Colors];if(attr){if(buffer===this._cachedValues.colors){return}this._cachedValues.colors=buffer;this.attributes[attr](buffer)}}}function compileShader(gl,code,type){let shader=gl.createShader(type);gl.shaderSource(shader,code);gl.compileShader(shader);if(!gl.getShaderParameter(shader,gl.COMPILE_STATUS)){_logger.error(`Error compiling ${type===gl.VERTEX_SHADER?"vertex":"fragment"} shader:`);_logger.error(gl.getShaderInfoLog(shader));throw new Error("Failed to compile a shader.")}return shader}const UniformTypes={Texture:"uniform1i",Matrix:"uniformMatrix4fv",Color:"uniform4fv",Float:"uniform1f",FloatArray:"uniform1fv",Int:"uniform1i",IntArray:"uniform1iv",Float2:"uniform2f",Float2Array:"uniform2fv",Int2:"uniform2i",Int2Array:"uniform2iv",Float3:"uniform3f",Float3Array:"uniform3fv",Int3:"uniform3i",Int3Array:"uniform3iv",Float4:"uniform4f",Float4Array:"uniform4fv",Int4:"uniform4i",Int4Array:"uniform4iv"};Object.defineProperty(UniformTypes,"_values",{value:new Set(Object.values(UniformTypes)),writable:false});Object.freeze(UniformTypes);Effect.UniformTypes=UniformTypes;Effect.UniformBinds={MainTexture:"texture",Color:"color",Projection:"projection",World:"world",UvOffset:"uvOffset",UvScale:"uvScale"};Object.freeze(Effect.UniformBinds);Effect.AttributeTypes={Byte:"BYTE",Short:"SHORT",UByte:"UNSIGNED_BYTE",UShort:"UNSIGNED_SHORT",Float:"FLOAT",HalfFloat:"HALF_FLOAT"};Object.freeze(Effect.AttributeTypes);Effect.AttributeBinds={Position:"position",TextureCoords:"uvs",Colors:"colors"};Object.freeze(Effect.AttributeBinds);module.exports=Effect},{"../../assets/texture_asset.js":8,"../../logger.js":38,"../../utils/color.js":47,"../../utils/rectangle.js":51,"../matrix.js":26}],23:[function(require,module,exports){"use strict";module.exports={Effect:require("./effect"),BasicEffect:require("./basic")}},{"./basic":21,"./effect":22}],24:[function(require,module,exports){"use strict";const IManager=require("../manager.js");const Color=require("../utils/color.js");const BlendModes=require("./blend_modes.js");const Rectangle=require("../utils/rectangle.js");const{Effect:Effect,BasicEffect:BasicEffect}=require("./effects");const TextureAsset=require("../assets/texture_asset.js");const TextureFilterModes=require("./texture_filter_modes.js");const TextureWrapModes=require("./texture_wrap_modes.js");const MeshGenerator=require("./mesh_generator.js");const Matrix=require("./matrix.js");const Camera=require("./camera.js");const Sprite=require("./sprite.js");const SpritesGroup=require("./sprites_group.js");const Vector2=require("../utils/vector2.js");const FontTextureAsset=require("../assets/font_texture_asset.js");const TextAlignment=require("./text_alignment.js");const Mesh=require("./mesh.js");const Circle=require("../utils/circle.js");const _whiteColor=Color.white;const _logger=require("../logger.js").getLogger("gfx");class Gfx extends IManager{constructor(){super();this._gl=null;this._initSettings={antialias:true,alpha:true,depth:false,premultipliedAlpha:true};this._canvas=null;this._lastBlendMode=null;this._activeEffect=null;this._camera=null;this._projection=null;this._currIndices=null;this._dynamicBuffers=null;this._fb=null;this.builtinEffects={};this.meshes={};this.defaultTextureFilter=TextureFilterModes.Nearest;this.defaultTextureWrapMode=TextureWrapModes.Clamp;this.whiteTexture=null;this._renderTarget=null;this._viewport=null;this._drawCallsCount=0}get batchSpritesCount(){return 2048}get maxLineSegments(){return 512}setContextAttributes(flags){if(this._gl){throw new Error("Can't call setContextAttributes() after gfx was initialized!")}this._initSettings=flags}setCanvas(element){if(this._gl){throw new Error("Can't call setCanvas() after gfx was initialized!")}this._canvas=element}get canvas(){return this._canvas}get Effect(){return Effect}get BasicEffect(){return BasicEffect}get Sprite(){return Sprite}get SpritesGroup(){return SpritesGroup}get Matrix(){return Matrix}get TextAlignment(){return TextAlignment}createCamera(withViewport){let ret=new Camera(this);if(withViewport){ret.viewport=this.getRenderingRegion()}return ret}createEffect(type){if(!(type.prototype instanceof Effect)){throw new Error("'type' must be a class type that inherits from 'Effect'.")}let effect=new type;effect._build(this._gl);return effect}maximizeCanvasSize(limitToParent){if(limitToParent){let parent=this._canvas.parentElement;let width=parent.clientWidth-this._canvas.offsetLeft;let height=parent.clientHeight-this._canvas.offsetTop;if(this._canvas.width!==width||this._canvas.height!==height){this.setResolution(width,height,true)}}else{let width=window.innerWidth;let height=window.innerHeight;this._canvas.style.left="0px";this._canvas.style.top="0px";if(this._canvas.width!==width||this._canvas.height!==height){this.setResolution(width,height,true)}}}setRenderTarget(texture){if(texture===null){this._renderTarget=null;this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,null);return}this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,this._fb);const attachmentPoint=this._gl.COLOR_ATTACHMENT0;this._gl.framebufferTexture2D(this._gl.FRAMEBUFFER,attachmentPoint,this._gl.TEXTURE_2D,texture.texture,0);this._renderTarget=texture}useEffect(effect){if(effect===null){this.useEffect(this.builtinEffects.Basic);return}if(this._activeEffect===effect){return}effect.setAsActive();this._activeEffect=effect;if(this._projection){this._activeEffect.setProjectionMatrix(this._projection)}}setResolution(width,height,updateCanvasStyle){this._canvas.width=width;this._canvas.height=height;if(updateCanvasStyle){this._canvas.style.width=width+"px";this._canvas.style.height=height+"px"}this._gl.viewport(0,0,width,height);this.resetCamera()}resetCamera(){this._camera=this.createCamera();let size=this.getCanvasSize();this._camera.orthographic(new Rectangle(0,0,size.x,size.y));this.applyCamera(this._camera)}applyCamera(camera){this._viewport=camera.viewport;let viewport=this.getRenderingRegion(true);this._gl.viewport(viewport.x,viewport.y,viewport.width,viewport.height);this._projection=camera.projection.clone();if(this._activeEffect){this._activeEffect.setProjectionMatrix(this._projection)}}getRenderingRegion(includeOffset){if(this._viewport){let ret=this._viewport.clone();if(includeOffset===false){ret.x=ret.y=0}return ret}return new Rectangle(0,0,(this._renderTarget||this._canvas).width,(this._renderTarget||this._canvas).height)}getRenderingSize(){let region=this.getRenderingRegion();return region.getSize()}getCanvasSize(){return new Vector2(this._canvas.width,this._canvas.height)}setup(){return new Promise(async(resolve,reject)=>{_logger.info("Setup gfx manager..");if(!this._canvas){this._canvas=document.createElement("canvas")}this._gl=this._canvas.getContext("webgl2",this._initSettings)||this._canvas.getContext("webgl",this._initSettings);if(!this._gl){_logger.error("Can't get WebGL context!");return reject("Failed to get WebGL context from canvas!")}this.builtinEffects.Basic=this.createEffect(BasicEffect);TextureAsset._setWebGl(this._gl);this._fb=this._gl.createFramebuffer();let _meshGenerator=new MeshGenerator(this._gl);this.meshes={quad:_meshGenerator.quad()};Object.freeze(this.meshes);let whitePixelImage=new Image;whitePixelImage.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+ip1sAAAAASUVORK5CYII=";await new Promise((resolve,reject)=>{whitePixelImage.onload=resolve});this.whiteTexture=new TextureAsset("__runtime_white_pixel__");this.whiteTexture.fromImage(whitePixelImage);this.useEffect(null);this._camera=this.createCamera();this.applyCamera(this._camera);this._dynamicBuffers={positionBuffer:this._gl.createBuffer(),positionArray:new Float32Array(3*4*this.batchSpritesCount),textureCoordBuffer:this._gl.createBuffer(),textureArray:new Float32Array(2*4*this.batchSpritesCount),colorsBuffer:this._gl.createBuffer(),colorsArray:new Float32Array(4*4*this.batchSpritesCount),indexBuffer:this._gl.createBuffer(),linesIndexBuffer:this._gl.createBuffer()};let indices=new Uint16Array(this.batchSpritesCount*6);let inc=0;for(let i=0;i<indices.length;i+=6){indices[i]=inc;indices[i+1]=inc+1;indices[i+2]=inc+2;indices[i+3]=inc+1;indices[i+4]=inc+3;indices[i+5]=inc+2;inc+=4}this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,this._dynamicBuffers.indexBuffer);this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,indices,this._gl.STATIC_DRAW);let lineIndices=new Uint16Array(this.maxLineSegments);for(let i=0;i<lineIndices.length;i+=6){lineIndices[i]=i}this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,this._dynamicBuffers.linesIndexBuffer);this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,lineIndices,this._gl.STATIC_DRAW);resolve()})}buildText(fontTexture,text,fontSize,color,alignment,marginFactor){if(!fontTexture||!fontTexture.valid){throw new Error("Font texture is invalid!")}if(!text){throw new Error("Text is invalid!")}alignment=alignment||TextAlignment.Left;color=color||Color.black;fontSize=fontSize||fontTexture.fontSize;marginFactor=marginFactor||Vector2.one;let scale=fontSize/fontTexture.fontSize;let position=new Vector2(0,0);let currentLineSprites=[];let lineWidth=0;function breakLine(){let offsetX=0;switch(alignment){case TextAlignment.Right:offsetX=-lineWidth;break;case TextAlignment.Center:offsetX=-lineWidth/2;break}if(offsetX!=0){for(let i=0;i<currentLineSprites.length;++i){currentLineSprites[i].position.x+=offsetX}}position.x=0;position.y+=fontTexture.lineHeight*scale*marginFactor.y;currentLineSprites=[];lineWidth=0}let ret=new SpritesGroup;for(let i=0;i<text.length;++i){let character=text[i];let sourceRect=fontTexture.getSourceRect(character);if(character==="\n"){breakLine();continue}let size=new Vector2(sourceRect.width*scale,sourceRect.height*scale);if(character!==" "){let sprite=new Sprite(fontTexture.texture,sourceRect);sprite.size=size;sprite.position.copy(position);sprite.color.copy(color);sprite.origin.x=0;ret.add(sprite);currentLineSprites.push(sprite)}lineWidth+=size.x*marginFactor.x;position.x+=size.x*marginFactor.x}breakLine();return ret}drawGroup(group,useBatching,cullOutOfScreen){if(useBatching||useBatching===undefined){this._drawBatch(group,Boolean(cullOutOfScreen))}else{if(cullOutOfScreen){_logger.warn("'cullOutOfScreen' is only useable when using batch rendering!")}let transform=group.getTransform();for(let i=0;i<group._sprites.length;++i){this.drawSprite(group._sprites[i],transform)}}}drawSprite(sprite,transform){this.draw(sprite.texture,sprite.position,sprite.size,sprite.sourceRect,sprite.color,sprite.blendMode,sprite.rotation,sprite.origin,transform)}cover(texture,destRect,sourceRect,color,blendMode){if(destRect instanceof Vector2){destRect=new Rectangle(0,0,destRect.x,destRect.y)}return this.draw(texture,destRect.getCenter(),destRect.getSize(),sourceRect,color,blendMode)}draw(texture,position,size,sourceRect,color,blendMode,rotation,origin,transform){if(!texture.texture){return}if(typeof size==="number"){size={x:size,y:size}}if(!origin){origin=Vector2.half}let world;if(rotation){world=Matrix.multiplyManyIntoFirst([Matrix.translate(Math.floor(position.x),Math.floor(position.y),0),Matrix.rotateZ(-rotation),Matrix.translate(Math.floor((1-origin.x-.5)*size.x),Math.floor((1-origin.y-.5)*size.y),0),Matrix.scale(Math.floor(size.x),Math.floor(size.y))])}else{world=Matrix.multiplyIntoFirst(Matrix.translate(Math.floor(position.x+(1-origin.x-.5)*size.x),Math.floor(position.y+(1-origin.y-.5)*size.y),0),Matrix.scale(Math.floor(size.x),Math.floor(size.y)))}this._drawImp(texture,sourceRect,color,blendMode,world,transform)}fillRect(destRect,color,blend,rotation){this.draw(this.whiteTexture,new Vector2(destRect.x+destRect.width/2,destRect.y+destRect.height/2),new Vector2(destRect.width,destRect.height),null,color,blend||BlendModes.Opaque,rotation,null,null)}outlineRect(destRect,color,blend,rotation){let topLeft=destRect.getTopLeft();let topRight=destRect.getTopRight();let bottomRight=destRect.getBottomRight();let bottomLeft=destRect.getBottomLeft();if(rotation){let center=destRect.getCenter();topLeft.subSelf(center);topRight.subSelf(center);bottomLeft.subSelf(center);bottomRight.subSelf(center);let cos=Math.cos(rotation);let sin=Math.sin(rotation);function rotateVec(vector){let x=vector.x*cos-vector.y*sin;let y=vector.x*sin+vector.y*cos;vector.set(x,y)}rotateVec(topLeft);rotateVec(topRight);rotateVec(bottomLeft);rotateVec(bottomRight);topLeft.addSelf(center);topRight.addSelf(center);bottomLeft.addSelf(center);bottomRight.addSelf(center)}this.drawLinesStrip([topLeft,topRight,bottomRight,bottomLeft],color,blend,true)}outlineCircle(circle,color,blend,lineAmount){if(lineAmount===undefined){lineAmount=32}let lines=[];const twicePi=2*Math.PI;for(let i=0;i<=lineAmount;i++){let point=new Vector2(circle.center.x+circle.radius*Math.cos(i*twicePi/lineAmount),circle.center.y+circle.radius*Math.sin(i*twicePi/lineAmount));lines.push(point)}this.drawLinesStrip(lines,color,blend)}fillCircle(circle,color,blend,lineAmount){if(lineAmount===undefined){lineAmount=32}let lines=[circle.center];const twicePi=2*Math.PI;for(let i=0;i<=lineAmount;i++){let point=new Vector2(circle.center.x+circle.radius*Math.cos(i*twicePi/lineAmount),circle.center.y+circle.radius*Math.sin(i*twicePi/lineAmount));lines.push(point)}this._fillShapesBuffer(lines,color,blend);let gl=this._gl;gl.drawArrays(gl.TRIANGLE_FAN,0,lines.length);this._drawCallsCount++}drawLine(startPoint,endPoint,color,blendMode){return this.drawLines([startPoint,endPoint],color,blendMode,false)}drawLinesStrip(points,colors,blendMode,looped){this._fillShapesBuffer(points,colors,blendMode);let gl=this._gl;let linesType=Boolean(looped)?gl.LINE_LOOP:gl.LINE_STRIP;gl.drawArrays(linesType,0,points.length);this._drawCallsCount++}drawLines(points,colors,blendMode){this._fillShapesBuffer(points,colors,blendMode);let gl=this._gl;gl.drawArrays(gl.LINES,0,points.length);this._drawCallsCount++}_fillShapesBuffer(points,colors,blendMode){colors=colors||_whiteColor;blendMode=blendMode||BlendModes.Opaque;if(colors.length!==undefined&&colors.length!==points.length){_logger.error("When drawing shapes with colors array, the colors array and points array must have the same length!");return}if(points.length>this.maxLineSegments){_logger.error(`Cannot draw shapes with more than ${this.maxLineSegments} vertices!`);return}let gl=this._gl;let positionsBuff=this._dynamicBuffers.positionArray;let colorsBuff=this._dynamicBuffers.colorsArray;for(let i=0;i<points.length;++i){positionsBuff[i*3+0]=points[i].x;positionsBuff[i*3+1]=points[i].y;positionsBuff[i*3+2]=points[i].z||0;let color=colors[i]||colors;colorsBuff[i*4+0]=color.r;colorsBuff[i*4+1]=color.g;colorsBuff[i*4+2]=color.b;colorsBuff[i*4+3]=color.a}this._setBlendMode(blendMode);let mesh=new Mesh(this._dynamicBuffers.positionBuffer,null,this._dynamicBuffers.colorsBuffer,this._dynamicBuffers.indexBuffer,points.length);this._activeEffect.prepareToDrawBatch(mesh,Matrix.identity);this._setActiveTexture(this.whiteTexture);let shouldSliceArrays=points.length<=8;this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._dynamicBuffers.positionBuffer);this._gl.bufferData(this._gl.ARRAY_BUFFER,shouldSliceArrays?this._dynamicBuffers.positionArray.slice(0,points.length*3):this._dynamicBuffers.positionArray,this._gl.DYNAMIC_DRAW);this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._dynamicBuffers.colorsBuffer);this._gl.bufferData(this._gl.ARRAY_BUFFER,shouldSliceArrays?this._dynamicBuffers.colorsArray.slice(0,points.length*4):this._dynamicBuffers.colorsArray,this._gl.DYNAMIC_DRAW);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this._dynamicBuffers.linesIndexBuffer);this._currIndices=null}_drawBatch(group,cullOutOfScreen){if(group._sprites.length===0){return}var transform=group.getTransform();var gl=this._gl;var positions=this._dynamicBuffers.positionArray;var uvs=this._dynamicBuffers.textureArray;var colors=this._dynamicBuffers.colorsArray;var currTexture=null;var currBlendMode=null;var currBatchSpritesCount=0;let drawCurrentBatch=()=>{this._setBlendMode(currBlendMode);let mesh=new Mesh(this._dynamicBuffers.positionBuffer,this._dynamicBuffers.textureCoordBuffer,this._dynamicBuffers.colorsBuffer,this._dynamicBuffers.indexBuffer,currBatchSpritesCount*6);this._activeEffect.prepareToDrawBatch(mesh,transform||Matrix.identity);this._setActiveTexture(currTexture);let shouldSliceArrays=currBatchSpritesCount<this.batchSpritesCount/2;this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._dynamicBuffers.positionBuffer);this._gl.bufferData(this._gl.ARRAY_BUFFER,shouldSliceArrays?this._dynamicBuffers.positionArray.slice(0,currBatchSpritesCount*4*3):this._dynamicBuffers.positionArray,this._gl.DYNAMIC_DRAW);this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._dynamicBuffers.textureCoordBuffer);this._gl.bufferData(this._gl.ARRAY_BUFFER,shouldSliceArrays?this._dynamicBuffers.textureArray.slice(0,currBatchSpritesCount*4*2):this._dynamicBuffers.textureArray,this._gl.DYNAMIC_DRAW);this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._dynamicBuffers.colorsBuffer);this._gl.bufferData(this._gl.ARRAY_BUFFER,shouldSliceArrays?this._dynamicBuffers.colorsArray.slice(0,currBatchSpritesCount*4*4):this._dynamicBuffers.colorsArray,this._gl.DYNAMIC_DRAW);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this._dynamicBuffers.indexBuffer);this._currIndices=null;gl.drawElements(gl.TRIANGLES,currBatchSpritesCount*6,gl.UNSIGNED_SHORT,0);this._drawCallsCount++;currBatchSpritesCount=0};currTexture=group._sprites[0].texture;currBlendMode=group._sprites[0].blendMode;for(let i=0;i<group._sprites.length;++i){let sprite=group._sprites[i];if(currBatchSpritesCount>=this.batchSpritesCount||sprite.blendMode!==currBlendMode||sprite.texture!==currTexture){drawCurrentBatch();currTexture=sprite.texture;currBlendMode=sprite.blendMode}let sizeX=sprite.size.x;let sizeY=sprite.size.y;let left=-sizeX*sprite.origin.x;let top=-sizeY*sprite.origin.y;let topLeft=new Vector2(left,top);let topRight=new Vector2(left+sizeX,top);let bottomLeft=new Vector2(left,top+sizeY);let bottomRight=new Vector2(left+sizeX,top+sizeY);if(sprite.rotation){let cos=Math.cos(sprite.rotation);let sin=Math.sin(sprite.rotation);function rotateVec(vector){let x=vector.x*cos-vector.y*sin;let y=vector.x*sin+vector.y*cos;vector.set(x,y)}rotateVec(topLeft);rotateVec(topRight);rotateVec(bottomLeft);rotateVec(bottomRight)}topLeft.addSelf(sprite.position);topRight.addSelf(sprite.position);bottomLeft.addSelf(sprite.position);bottomRight.addSelf(sprite.position);if(cullOutOfScreen){let region=this.getRenderingRegion();if(!region.containsVector(topLeft)&&!region.containsVector(topRight)&&!region.containsVector(bottomLeft)&&!region.containsVector(bottomRight)){continue}}let pi=currBatchSpritesCount*4*3;positions[pi+0]=topLeft.x;positions[pi+1]=topLeft.y;positions[pi+2]=0;positions[pi+3]=topRight.x;positions[pi+4]=topRight.y;positions[pi+5]=0;positions[pi+6]=bottomLeft.x;positions[pi+7]=bottomLeft.y;positions[pi+8]=0;positions[pi+9]=bottomRight.x;positions[pi+10]=bottomRight.y;positions[pi+11]=0;let uvi=currBatchSpritesCount*4*2;if(sprite.sourceRect){let uvTl={x:sprite.sourceRect.x/currTexture.width,y:sprite.sourceRect.y/currTexture.height};let uvBr={x:uvTl.x+sprite.sourceRect.width/currTexture.width,y:uvTl.y+sprite.sourceRect.height/currTexture.height};uvs[uvi+0]=uvTl.x;uvs[uvi+1]=uvTl.y;uvs[uvi+2]=uvBr.x;uvs[uvi+3]=uvTl.y;uvs[uvi+4]=uvTl.x;uvs[uvi+5]=uvBr.y;uvs[uvi+6]=uvBr.x;uvs[uvi+7]=uvBr.y}else{uvs[uvi+0]=0;uvs[uvi+1]=0;uvs[uvi+2]=1;uvs[uvi+3]=0;uvs[uvi+4]=0;uvs[uvi+5]=1;uvs[uvi+6]=1;uvs[uvi+7]=1}let ci=currBatchSpritesCount*4*4;for(let x=0;x<4;++x){colors[ci+x*4+0]=sprite.color.r;colors[ci+x*4+1]=sprite.color.g;colors[ci+x*4+2]=sprite.color.b;colors[ci+x*4+3]=sprite.color.a}currBatchSpritesCount++}if(currBatchSpritesCount>0){drawCurrentBatch()}}_drawImp(texture,sourceRect,color,blendMode,world,parentTransform){this._setBlendMode(blendMode||BlendModes.AlphaBlend);if(parentTransform){world=Matrix.multiply(parentTransform,world)}let quad=this.meshes.quad;quad.overrideColors(this._gl,color||_whiteColor);this._activeEffect.prepareToDraw(quad,color,world,sourceRect,texture);if(quad.indices!==this._currIndices){this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,quad.indices);this._currIndices=quad.indices}this._setActiveTexture(texture);this._gl.drawArrays(this._gl.TRIANGLE_STRIP,0,4);this._drawCallsCount++}_setActiveTexture(texture){if(this._activeEffect.setTexture(texture)){this._setTextureFilter(texture.filter||this.defaultTextureFilter);this._setTextureWrapMode(texture.wrapMode||this.defaultTextureWrapMode)}}get BlendModes(){return BlendModes}get TextureWrapModes(){return TextureWrapModes}get TextureFilterModes(){return TextureFilterModes}get drawCallsCount(){return this._drawCallsCount}clear(color){color=color||Color.black;this._gl.clearColor(color.r,color.g,color.b,color.a);this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT)}_setTextureFilter(filter){if(!TextureFilterModes._values.has(filter)){throw new Error("Invalid texture filter mode! Please pick a value from 'TextureFilterModes'.")}let glMode=this._gl[filter];this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,glMode);this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,glMode)}_setTextureWrapMode(wrapX,wrapY){if(wrapY===undefined){wrapY=wrapX}if(!TextureWrapModes._values.has(wrapX)){throw new Error("Invalid texture wrap mode! Please pick a value from 'WrapModes'.")}if(!TextureWrapModes._values.has(wrapY)){throw new Error("Invalid texture wrap mode! Please pick a value from 'WrapModes'.")}this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl[wrapX]);this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl[wrapY])}_setBlendMode(blendMode){if(this._lastBlendMode!==blendMode){var gl=this._gl;switch(blendMode){case BlendModes.AlphaBlend:gl.enable(gl.BLEND);gl.blendEquation(gl.FUNC_ADD);gl.blendFunc(gl.ONE,gl.ONE_MINUS_SRC_ALPHA);break;case BlendModes.Opaque:gl.disable(gl.BLEND);break;case BlendModes.Additive:gl.enable(gl.BLEND);gl.blendEquation(gl.FUNC_ADD);gl.blendFunc(gl.ONE,gl.ONE);break;case BlendModes.Multiply:gl.enable(gl.BLEND);gl.blendEquation(gl.FUNC_ADD);gl.blendFuncSeparate(gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA,gl.ONE,gl.ONE_MINUS_SRC_ALPHA);break;case BlendModes.Screen:gl.enable(gl.BLEND);gl.blendEquation(gl.FUNC_ADD);gl.blendFuncSeparate(gl.ONE,gl.ONE_MINUS_SRC_COLOR,gl.ONE,gl.ONE_MINUS_SRC_ALPHA);break;case BlendModes.Subtract:gl.enable(gl.BLEND);gl.blendEquation(gl.FUNC_ADD);gl.blendFuncSeparate(gl.ONE,gl.ONE,gl.ONE,gl.ONE);gl.blendEquationSeparate(gl.FUNC_REVERSE_SUBTRACT,gl.FUNC_ADD);break;case BlendModes.Invert:gl.enable(gl.BLEND);gl.blendEquation(gl.FUNC_ADD);gl.blendFunc(gl.ONE_MINUS_DST_COLOR,gl.ZERO);gl.blendFuncSeparate(gl.ONE_MINUS_DST_COLOR,gl.ZERO,gl.ONE,gl.ONE_MINUS_SRC_ALPHA);break;case BlendModes.Overlay:gl.enable(gl.BLEND);if(gl.MAX){gl.blendEquation(gl.MAX);gl.blendFunc(gl.ONE,gl.ONE_MINUS_SRC_ALPHA)}else{gl.blendEquation(gl.FUNC_ADD);gl.blendFunc(gl.ONE,gl.ONE)}break;case BlendModes.Darken:gl.enable(gl.BLEND);gl.blendEquation(gl.MIN);gl.blendFuncSeparate(gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA,gl.ONE,gl.ONE_MINUS_SRC_ALPHA);break;case BlendModes.DestIn:gl.enable(gl.BLEND);gl.blendEquation(gl.FUNC_ADD);gl.blendFunc(gl.ZERO,gl.SRC_ALPHA);break;case BlendModes.DestOut:gl.enable(gl.BLEND);gl.blendEquation(gl.FUNC_ADD);gl.blendFunc(gl.ZERO,gl.ONE_MINUS_SRC_ALPHA);break;default:throw new Error(`Unknown blend mode '${blendMode}'!`)}this._lastBlendMode=blendMode}}startFrame(){this._lastBlendMode=null;this._drawCallsCount=0}endFrame(){}destroy(){_logger.warn("Cleaning up WebGL is not supported yet!")}}module.exports=new Gfx},{"../assets/font_texture_asset.js":4,"../assets/texture_asset.js":8,"../logger.js":38,"../manager.js":39,"../utils/circle.js":46,"../utils/color.js":47,"../utils/rectangle.js":51,"../utils/vector2.js":53,"./blend_modes.js":19,"./camera.js":20,"./effects":23,"./matrix.js":26,"./mesh.js":27,"./mesh_generator.js":28,"./sprite.js":29,"./sprites_group.js":30,"./text_alignment.js":31,"./texture_filter_modes.js":32,"./texture_wrap_modes.js":33}],25:[function(require,module,exports){"use strict";module.exports=require("./gfx")},{"./gfx":24}],26:[function(require,module,exports){"use strict";class Matrix{constructor(values,cloneValues){if(cloneValues||cloneValues===undefined){this.values=values.slice(0)}else{this.values=values}}set(v11,v12,v13,v14,v21,v22,v23,v24,v31,v32,v33,v34,v41,v42,v43,v44){this.values=new Float32Array([v11,v12,v13,v14,v21,v22,v23,v24,v31,v32,v33,v34,v41,v42,v43,v44])}clone(){let ret=new Matrix(this.values,true);return ret}equals(other){if(other===this){return true}if(!other){return false}for(let i=0;i<this.values.length;++i){if(this.values[i]!==other.values[i]){return false}}return true}static orthographic(left,right,bottom,top,near,far){return new Matrix([2/(right-left),0,0,0,0,2/(top-bottom),0,0,0,0,2/(near-far),0,(left+right)/(left-right),(bottom+top)/(bottom-top),(near+far)/(near-far),1],false)}static perspective(fieldOfViewInRadians,aspectRatio,near,far){var f=1/Math.tan(fieldOfViewInRadians/2);var rangeInv=1/(near-far);return new Matrix([f/aspectRatio,0,0,0,0,f,0,0,0,0,(near+far)*rangeInv,-1,0,0,near*far*rangeInv*2,0],false)}static translate(x,y,z){return new Matrix([1,0,0,0,0,1,0,0,0,0,1,0,x||0,y||0,z||0,1],false)}static scale(x,y,z){return new Matrix([x||1,0,0,0,0,y||1,0,0,0,0,z||1,0,0,0,0,1],false)}static rotateX(a){let sin=Math.sin;let cos=Math.cos;return new Matrix([1,0,0,0,0,cos(a),-sin(a),0,0,sin(a),cos(a),0,0,0,0,1],false)}static rotateY(a){let sin=Math.sin;let cos=Math.cos;return new Matrix([cos(a),0,sin(a),0,0,1,0,0,-sin(a),0,cos(a),0,0,0,0,1],false)}static rotateZ(a){let sin=Math.sin;let cos=Math.cos;return new Matrix([cos(a),-sin(a),0,0,sin(a),cos(a),0,0,0,0,1,0,0,0,0,1],false)}static multiply(matrixA,matrixB){let row0=[matrixB.values[0],matrixB.values[1],matrixB.values[2],matrixB.values[3]];let row1=[matrixB.values[4],matrixB.values[5],matrixB.values[6],matrixB.values[7]];let row2=[matrixB.values[8],matrixB.values[9],matrixB.values[10],matrixB.values[11]];let row3=[matrixB.values[12],matrixB.values[13],matrixB.values[14],matrixB.values[15]];let result0=multiplyMatrixAndPoint(matrixA.values,row0);let result1=multiplyMatrixAndPoint(matrixA.values,row1);let result2=multiplyMatrixAndPoint(matrixA.values,row2);let result3=multiplyMatrixAndPoint(matrixA.values,row3);return new Matrix([result0[0],result0[1],result0[2],result0[3],result1[0],result1[1],result1[2],result1[3],result2[0],result2[1],result2[2],result2[3],result3[0],result3[1],result3[2],result3[3]],false)}static multiplyMany(matrices){let ret=matrices[0];for(let i=1;i<matrices.length;i++){ret=Matrix.multiply(ret,matrices[i])}return ret}static multiplyIntoFirst(matrixA,matrixB){let row0=[matrixB.values[0],matrixB.values[1],matrixB.values[2],matrixB.values[3]];let row1=[matrixB.values[4],matrixB.values[5],matrixB.values[6],matrixB.values[7]];let row2=[matrixB.values[8],matrixB.values[9],matrixB.values[10],matrixB.values[11]];let row3=[matrixB.values[12],matrixB.values[13],matrixB.values[14],matrixB.values[15]];let result0=multiplyMatrixAndPoint(matrixA.values,row0);let result1=multiplyMatrixAndPoint(matrixA.values,row1);let result2=multiplyMatrixAndPoint(matrixA.values,row2);let result3=multiplyMatrixAndPoint(matrixA.values,row3);matrixA.set(result0[0],result0[1],result0[2],result0[3],result1[0],result1[1],result1[2],result1[3],result2[0],result2[1],result2[2],result2[3],result3[0],result3[1],result3[2],result3[3]);return matrixA}static multiplyManyIntoFirst(matrices){let ret=matrices[0];for(let i=1;i<matrices.length;i++){ret=Matrix.multiplyIntoFirst(ret,matrices[i])}return ret}}function multiplyMatrixAndPoint(matrix,point){let c0r0=matrix[0],c1r0=matrix[1],c2r0=matrix[2],c3r0=matrix[3];let c0r1=matrix[4],c1r1=matrix[5],c2r1=matrix[6],c3r1=matrix[7];let c0r2=matrix[8],c1r2=matrix[9],c2r2=matrix[10],c3r2=matrix[11];let c0r3=matrix[12],c1r3=matrix[13],c2r3=matrix[14],c3r3=matrix[15];let x=point[0];let y=point[1];let z=point[2];let w=point[3];let resultX=x*c0r0+y*c0r1+z*c0r2+w*c0r3;let resultY=x*c1r0+y*c1r1+z*c1r2+w*c1r3;let resultZ=x*c2r0+y*c2r1+z*c2r2+w*c2r3;let resultW=x*c3r0+y*c3r1+z*c3r2+w*c3r3;return[resultX,resultY,resultZ,resultW]}Matrix.identity=new Matrix([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],false);Object.freeze(Matrix.identity);module.exports=Matrix},{}],27:[function(require,module,exports){"use strict";const{Color:Color}=require("../utils");class Mesh{constructor(positions,textureCoords,colorsBuffer,indices,indicesCount){this.positions=positions;this.textureCoords=textureCoords;this.colors=colorsBuffer;this.indices=indices;this.indicesCount=indicesCount;this.__color=new Color(-1,-1,-1,-1);Object.freeze(this)}overrideColors(gl,color){if(color.equals(this.__color)){return}this.__color.copy(color);gl.bindBuffer(gl.ARRAY_BUFFER,this.colors);const colors=[];for(let i=0;i<this.indicesCount;++i){colors.push(color.r);colors.push(color.g);colors.push(color.b);colors.push(color.a)}gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(colors),gl.DYNAMIC_DRAW)}}module.exports=Mesh},{"../utils":49}],28:[function(require,module,exports){"use strict";const Mesh=require("./mesh");class MeshGenerator{constructor(gl){this._gl=gl}quad(){const gl=this._gl;const positionBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,positionBuffer);let x=.5;const positions=[-x,-x,0,x,-x,0,-x,x,0,x,x,0];gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(positions),gl.STATIC_DRAW);const textureCoordBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,textureCoordBuffer);const textureCoordinates=[0,0,1,0,0,1,1,1];gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(textureCoordinates),gl.STATIC_DRAW);const colorsBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,colorsBuffer);const colors=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(colors),gl.DYNAMIC_DRAW);const indexBuffer=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,indexBuffer);const indices=[0,1,3,2];gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(indices),gl.STATIC_DRAW);return new Mesh(positionBuffer,textureCoordBuffer,colorsBuffer,indexBuffer,indices.length)}}module.exports=MeshGenerator},{"./mesh":27}],29:[function(require,module,exports){"use strict";const TextureAsset=require("../assets/texture_asset");const Color=require("../utils/color");const Rectangle=require("../utils/rectangle");const Vector2=require("../utils/vector2");const BlendModes=require("./blend_modes");class Sprite{constructor(texture,sourceRect){this.texture=texture;this.position=new Vector2(0,0);this.size=new Vector2(100,100);this.sourceRect=sourceRect||null;this.blendMode=BlendModes.AlphaBlend;this.rotation=0;this.origin=new Vector2(.5,.5);this.color=Color.white}clone(){let ret=new Sprite(this.texture,this.sourceRect);ret.position=this.position.clone();ret.size=this.size.clone();ret.blendMode=this.blendMode;ret.rotation=this.rotation;ret.origin=this.origin.clone();ret.color=this.color.clone();return ret}get flipX(){return this.size.x<0}set flipX(flip){if(flip===undefined)flip=!this.flipX;this.size.x=Math.abs(this.size.x)*(flip?-1:1);return flip}get flipY(){return this.size.y<0}set flipY(flip){if(flip===undefined)flip=!this.flipY;this.size.y=Math.abs(this.size.y)*(flip?-1:1);return flip}}module.exports=Sprite},{"../assets/texture_asset":8,"../utils/color":47,"../utils/rectangle":51,"../utils/vector2":53,"./blend_modes":19}],30:[function(require,module,exports){"use strict";const Color=require("../utils/color");const Vector2=require("../utils/vector2");const Matrix=require("./matrix");const Sprite=require("./sprite");class SpritesGroup{constructor(){this._sprites=[];this.rotation=0;this.position=new Vector2(0,0);this.scale=new Vector2(1,1)}forEach(callback){this._sprites.forEach(callback)}setColor(color){for(let i=0;i<this._sprites.length;++i){this._sprites[i].color.copy(color)}}getTransform(){let matrices=[];if(this.position.x!==0||this.position.y!==0){matrices.push(Matrix.translate(this.position.x,this.position.y,0))}if(this.rotation){matrices.push(Matrix.rotateZ(-this.rotation))}if(this.scale.x!==1||this.scale.y!==1){matrices.push(Matrix.scale(this.scale.x,this.scale.y))}if(matrices.length===0){return null}if(matrices.length===1){return matrices[0]}return Matrix.multiplyMany(matrices)}add(sprite){this._sprites.push(sprite);return sprite}remove(sprite){for(let i=0;i<this._sprites.length;++i){if(this._sprites[i]===sprite){this._sprites.splice(i,1);return}}}shift(){return this._sprites.shift()}sort(compare){this._sprites.sort(compare)}sortForBatching(){this._sprites.sort((a,b)=>{let at=a.texture.url+a.blendMode;let bt=b.texture.url+b.blendMode;return at>bt?1:bt>at?-1:0})}get count(){return this._sprites.length}}module.exports=SpritesGroup},{"../utils/color":47,"../utils/vector2":53,"./matrix":26,"./sprite":29}],31:[function(require,module,exports){"use strict";const TextAlignment={Left:"left",Right:"right",Center:"center"};Object.freeze(TextAlignment);module.exports=TextAlignment},{}],32:[function(require,module,exports){"use strict";const TextureFilterModes={Nearest:"NEAREST",Linear:"LINEAR",NearestMipmapNearest:"NEAREST_MIPMAP_NEAREST",LinearMipmapNearest:"LINEAR_MIPMAP_NEAREST",NearestMipmapLinear:"NEAREST_MIPMAP_LINEAR",LinearMipmapLinear:"LINEAR_MIPMAP_LINEAR"};Object.defineProperty(TextureFilterModes,"_values",{value:new Set(Object.values(TextureFilterModes)),writable:false});Object.freeze(TextureFilterModes);module.exports=TextureFilterModes},{}],33:[function(require,module,exports){"use strict";const TextureWrapModes={Clamp:"CLAMP_TO_EDGE",Repeat:"REPEAT",RepeatMirrored:"MIRRORED_REPEAT"};Object.defineProperty(TextureWrapModes,"_values",{value:new Set(Object.values(TextureWrapModes)),writable:false});Object.freeze(TextureWrapModes);module.exports=TextureWrapModes},{}],34:[function(require,module,exports){"use strict";module.exports=require("./shaku")},{"./shaku":44}],35:[function(require,module,exports){"use strict";module.exports=require("./input")},{"./input":36}],36:[function(require,module,exports){"use strict";const IManager=require("../manager.js");const Vector2=require("../utils/vector2.js");const{MouseButtons:MouseButtons,KeyboardKeys:KeyboardKeys}=require("./key_codes.js");const _logger=require("../logger.js").getLogger("input");class Input extends IManager{constructor(){super();this._callbacks=null;this._targetElement=window;this.MouseButtons=MouseButtons;this.KeyboardKeys=KeyboardKeys;this.preventDefaults=false;this.enableMouseDeltaWhileMouseWheelDown=true;this.disableContextMenu=true;this.resetOnFocusLoss=true;this._resetAll()}setup(){return new Promise((resolve,reject)=>{_logger.info("Setup input manager..");if(typeof this._targetElement==="function"){this._targetElement=this._targetElement();if(!this._targetElement){throw new Error("Input target element was set to be a method, but the returned value was invalid!")}}let element=this._targetElement;if(element.tabIndex===-1||element.tabIndex===undefined){element.tabIndex=1e3}window.setTimeout(()=>element.focus(),0);var _this=this;this._callbacks={mousedown:function(event){_this._onMouseDown(event);if(this.preventDefaults)event.preventDefault()},mouseup:function(event){_this._onMouseUp(event);if(this.preventDefaults)event.preventDefault()},mousemove:function(event){_this._onMouseMove(event);if(this.preventDefaults)event.preventDefault()},keydown:function(event){_this._onKeyDown(event);if(this.preventDefaults)event.preventDefault()},keyup:function(event){_this._onKeyUp(event);if(this.preventDefaults)event.preventDefault()},blur:function(event){_this._onBlur(event);if(this.preventDefaults)event.preventDefault()},wheel:function(event){_this._onMouseWheel(event)},touchstart:function(event){_this._onTouchStart(event);if(this.preventDefaults)event.preventDefault()},touchend:function(event){_this._onMouseUp(event);if(this.preventDefaults)event.preventDefault()},touchmove:function(event){_this._onMouseMove(event);if(this.preventDefaults)event.preventDefault()},contextmenu:function(event){if(_this.disableContextMenu){event.preventDefault()}}};this._resetAll();for(var event in this._callbacks){element.addEventListener(event,this._callbacks[event],false)}if(element!==window){window.addEventListener("mouseup",this._callbacks["mouseup"],false);window.addEventListener("touchend",this._callbacks["touchend"],false)}resolve()})}startFrame(){}destroy(){if(this._callbacks){let element=this._targetElement;for(var event in this._callbacks){element.removeEventListener(event,this._callbacks[event])}if(element!==window){window.removeEventListener("mouseup",this._callbacks["mouseup"],false);window.removeEventListener("touchend",this._callbacks["touchend"],false)}this._callbacks=null}}setTargetElement(element){if(this._callbacks){throw new Error("'setTargetElement() must be called before initializing the input manager!")}this._targetElement=element}_resetAll(){this._mousePos=new Vector2;this._mousePrevPos=new Vector2;this._mouseState={};this._mousePrevState={};this._mouseWheel=0;this._keyboardState={};this._keyboardPrevState={};this._touchStarted=false}get mousePosition(){return this._mousePos.clone()}get prevMousePosition(){return(this._mousePrevPos||this._mousePos).clone()}get mouseDelta(){if(!this._mousePrevPos){return Vector2.zero}return new Vector2(this._mousePos.x-this._mousePrevPos.x,this._mousePos.y-this._mousePrevPos.y)}get mouseMoving(){return this._mousePrevPos&&!this._mousePrevPos.equals(this._mousePos)}mousePressed(button=0){if(button===undefined)throw new Error("Invalid button code!");return Boolean(this._mouseState[button]&&!this._mousePrevState[button])}mouseDown(button=0){if(button===undefined)throw new Error("Invalid button code!");return Boolean(this._mouseState[button])}mouseUp(button=0){if(button===undefined)throw new Error("Invalid button code!");return Boolean(!this.mouseDown(button))}mouseReleased(button=0){if(button===undefined)throw new Error("Invalid button code!");return Boolean(!this._mouseState[button]&&this._mousePrevState[button])}keyDown(key){if(key===undefined)throw new Error("Invalid key code!");return Boolean(this._keyboardState[key])}keyUp(key){if(key===undefined)throw new Error("Invalid key code!");return Boolean(!this.keyDown(key))}keyReleased(key){if(key===undefined)throw new Error("Invalid key code!");return Boolean(!this._keyboardState[key]&&this._keyboardPrevState[key])}keyPressed(key){if(key===undefined)throw new Error("Invalid key code!");return Boolean(this._keyboardState[key]&&!this._keyboardPrevState[key])}get shiftDown(){return Boolean(this.keyDown(this.KeyboardKeys.shift))}get ctrlDown(){return Boolean(this.keyDown(this.KeyboardKeys.ctrl))}get altDown(){return Boolean(this.keyDown(this.KeyboardKeys.alt))}get anyKeyDown(){for(var key in this._keyboardState){if(this._keyboardState[key]){return true}}return false}get anyMouseButtonDown(){for(var key in this._mouseState){if(this._mouseState[key]){return true}}return false}_getValueWithCode(code,mouseCheck,keyboardCheck){code=String(code);if(code.indexOf("mouse_")===0){var codename=code.split("_")[1];return mouseCheck.call(this,this.MouseButtons[codename])}if(!isNaN(parseInt(code))&&code.length===1){code="n"+code}return keyboardCheck.call(this,this.KeyboardKeys[code])}down(code){return Boolean(this._getValueWithCode(code,this.mouseDown,this.keyDown))}released(code){return Boolean(this._getValueWithCode(code,this.mouseReleased,this.keyReleased))}pressed(code){return Boolean(this._getValueWithCode(code,this.mousePressed,this.keyPressed))}get mouseWheelSign(){return Math.sign(this._mouseWheel)}get mouseWheel(){return this._mouseWheel}endFrame(){this._mousePrevPos=this._mousePos.clone();this._keyboardPrevState={};for(var key in this._keyboardState){this._keyboardPrevState[key]=this._keyboardState[key]}this._mousePrevState={};for(var key in this._mouseState){this._mousePrevState[key]=this._mouseState[key]}if(this._touchStarted){this._mouseState[this.MouseButtons.left]=true;this._touchStarted=false}this._mouseWheel=0}_getKeyboardKeyCode(event){event=this._getEvent(event);return event.keyCode!==undefined?event.keyCode:event.key.charCodeAt(0)}_onBlur(event){if(this.resetOnFocusLoss){this._resetAll()}}_onMouseWheel(event){this._mouseWheel=event.deltaY}_onKeyDown(event){var keycode=this._getKeyboardKeyCode(event);this._keyboardState[keycode]=true}_onKeyUp(event){var keycode=this._getKeyboardKeyCode(event);this._keyboardState[keycode||0]=false}_onTouchStart(event){var touches=event.changedTouches;if(touches&&touches.length){var touch=touches[0];var x=touch.pageX||touch.offsetX||touch.clientX;var y=touch.pageY||touch.offsetY||touch.clientY;if(x!==undefined&&y!==undefined){this._mousePos.x=x-this._targetElement.clientX;this._mousePos.y=y-this._targetElement.clientY}}this._touchStarted=true}_onMouseDown(event){event=this._getEvent(event);if(this.enableMouseDeltaWhileMouseWheelDown&&event.button===this.MouseButtons.middle){event.preventDefault()}this._mouseState[event.button||0]=true}_onMouseUp(event){event=this._getEvent(event);this._mouseState[event.button||0]=false}_onTouchMove(event){this._mousePos.x=event.touches[0].pageX;this._mousePos.y=event.touches[0].pageY;this._normalizeMousePos()}_onMouseMove(event){event=this._getEvent(event);var pageX=event.clientX;if(pageX===undefined){pageX=event.x}if(pageX===undefined){pageX=event.offsetX}if(pageX===undefined){pageX=event.pageX}var pageY=event.clientY;if(pageY===undefined){pageY=event.y}if(pageY===undefined){pageY=event.offsetY}if(pageY===undefined){pageY=event.pageY}if(pageX===undefined){pageX=event.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;pageY=event.clientY+document.body.scrollTop+document.documentElement.scrollTop}this._mousePos.x=pageX;this._mousePos.y=pageY;this._normalizeMousePos()}_normalizeMousePos(){if(this._targetElement.getBoundingClientRect){var rect=this._targetElement.getBoundingClientRect();this._mousePos.x-=rect.left;this._mousePos.y-=rect.top}}_getEvent(event){return event||window.event}}module.exports=new Input},{"../logger.js":38,"../manager.js":39,"../utils/vector2.js":53,"./key_codes.js":37}],37:[function(require,module,exports){"use strict";const MouseButtons={left:0,middle:1,right:2};const KeyboardKeys={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,break:19,caps_lock:20,escape:27,page_up:33,page_down:34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,delete:46,space:32,n0:48,n1:49,n2:50,n3:51,n4:52,n5:53,n6:54,n7:55,n8:56,n9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,left_window_key:91,right_window_key:92,select_key:93,numpad_0:96,numpad_1:97,numpad_2:98,numpad_3:99,numpad_4:100,numpad_5:101,numpad_6:102,numpad_7:103,numpad_8:104,numpad_9:105,multiply:106,add:107,subtract:109,decimal_point:110,divide:111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scroll_lock:145,semicolon:186,equal_sign:187,plus:187,comma:188,dash:189,minus:189,period:190,forward_slash:191,grave_accent:192,open_bracket:219,back_slash:220,close_braket:221,single_quote:222};module.exports={KeyboardKeys:KeyboardKeys,MouseButtons:MouseButtons}},{}],38:[function(require,module,exports){"use strict";var _drivers=console;class Logger{constructor(name){this._nameHeader="[Shaku]["+name+"]";this._throwErrors=false}trace(msg){_drivers.trace(this._nameHeader,msg)}debug(msg){_drivers.debug(this._nameHeader,msg)}info(msg){_drivers.info(this._nameHeader,msg)}warn(msg){_drivers.warn(this._nameHeader,msg);if(this._throwErrors){throw new Error(msg)}}error(msg){_drivers.error(this._nameHeader,msg);if(this._throwErrors){throw new Error(msg)}}throwErrorOnWarnings(enable){this._throwErrors=Boolean(enable)}}class NullDrivers{constructor(){}trace(msg){}debug(msg){}info(msg){}warn(msg){}error(msg){}}module.exports={getLogger:function(name){return new Logger(name)},silent:function(){_drivers=new NullDrivers},setDrivers:function(drivers){_drivers=drivers}}},{}],39:[function(require,module,exports){"use strict";class IManager{setup(){throw new Error("Not Implemented!")}startFrame(){throw new Error("Not Implemented!")}endFrame(){throw new Error("Not Implemented!")}destroy(){throw new Error("Not Implemented!")}}module.exports=IManager},{}],40:[function(require,module,exports){"use strict";module.exports=require("./sfx")},{"./sfx":41}],41:[function(require,module,exports){"use strict";const SoundAsset=require("../assets/sound_asset.js");const IManager=require("../manager.js");const _logger=require("../logger.js").getLogger("sfx");const SoundInstance=require("./sound_instance.js");const SoundMixer=require("./sound_mixer.js");class Sfx extends IManager{constructor(){super();this._playingSounds=null}setup(){return new Promise((resolve,reject)=>{_logger.info("Setup sfx manager..");this._playingSounds=new Set;resolve()})}startFrame(){var playingSounds=Array.from(this._playingSounds);for(var i=0;i<playingSounds.length;++i){var sound=playingSounds[i];if(!sound.isPlaying){this._playingSounds.delete(sound)}}}endFrame(){var playingSounds=Array.from(this._playingSounds);for(var i=0;i<playingSounds.length;++i){var sound=playingSounds[i];if(!sound.isPlaying){this._playingSounds.delete(sound)}}}destroy(){this.stopAll();this._playingSounds=new Set}get SoundMixer(){return SoundMixer}play(sound,volume,playbackRate,preservesPitch){var sound=this.createSound(sound);sound.volume=volume!==undefined?volume:1;if(playbackRate!==undefined){sound.playbackRate=playbackRate}if(preservesPitch!==undefined){sound.preservesPitch=preservesPitch}sound.play()}stopAll(){var playingSounds=Array.from(this._playingSounds);for(var i=0;i<playingSounds.length;++i){var sound=playingSounds[i];sound.stop()}this._playingSounds=new Set}get playingSoundsCount(){return this._playingSounds.size}createSound(sound){if(!(sound instanceof SoundAsset)){throw new Error("Sound type must be an instance of SoundAsset!")}var ret=new SoundInstance(this,sound.url);return ret}get masterVolume(){return SoundInstance._masterVolume}set masterVolume(value){SoundInstance._masterVolume=value;return value}}module.exports=new Sfx},{"../assets/sound_asset.js":7,"../logger.js":38,"../manager.js":39,"./sound_instance.js":42,"./sound_mixer.js":43}],42:[function(require,module,exports){"use strict";const _logger=require("../logger.js").getLogger("sfx");class SoundInstance{constructor(sfxManager,url){if(!url){_logger.error("Sound type can't be null or invalid!");throw new Error("Invalid sound type to play in SoundInstance!")}this._sfx=sfxManager;this._audio=new Audio(url);this._volume=1}play(){if(this.playing){return}this._audio.play();this._sfx._playingSounds.add(this)}get playbackRate(){return this._audio.playbackRate}set playbackRate(val){if(val<.1){_logger.error("playbackRate value set is too low, value was capped to 0.1.")}if(val>10){_logger.error("playbackRate value set is too high, value was capped to 10.")}this._audio.playbackRate=val}get preservesPitch(){return Boolean(this._audio.preservesPitch||this._audio.mozPreservesPitch)}set preservesPitch(val){return this._audio.preservesPitch=this._audio.mozPreservesPitch=Boolean(val)}pause(){this._audio.pause()}replay(){this.stop();this.play()}stop(){this.pause();this.currentTime=0}get loop(){return this._audio.loop}set loop(value){this._audio.loop=value;return this._audio.loop}get volume(){return this._volume}set volume(value){this._volume=value;var volume=value*SoundInstance._masterVolume;if(volume<0){volume=0}if(volume>1){volume=1}this._audio.volume=volume;return this._volume}get currentTime(){return this._audio.currentTime}set currentTime(value){return this._audio.currentTime=value}get duration(){return this._audio.duration}get paused(){return this._audio.paused}get playing(){return!this.paused&&!this.finished}get finished(){return this._audio.ended}}SoundInstance._masterVolume=1;module.exports=SoundInstance},{"../logger.js":38}],43:[function(require,module,exports){"use strict";const SoundInstance=require("./sound_instance.js");class SoundMixer{constructor(sound1,sound2,allowOverlapping){this._sound1=sound1;this._sound2=sound2;this.fromSoundVolume=this._sound1?this._sound1.volume:0;this.toSoundVolume=this._sound2?this._sound2.volume:0;this.allowOverlapping=allowOverlapping;this.update(0)}stop(){if(this._sound1){this._sound1.stop()}if(this._sound2){this._sound2.stop()}}get fromSound(){return this._sound1}get toSound(){return this._sound2}get progress(){return this._progress}updateDelta(delta){this.update(this._progress+delta)}update(progress){if(progress<=0){if(this._sound1){this._sound1.volume=this.fromSoundVolume}if(this._sound2){this._sound2.volume=0;this._sound2.stop()}this._progress=0}if(progress>=1){if(this._sound2){this._sound2.volume=this.toSoundVolume}if(this._sound1){this._sound1.volume=0;this._sound1.stop()}this._progress=1}else{this._progress=progress;if(this._sound1){this._sound1.play()}if(this._sound2){this._sound2.play()}if(this.allowOverlapping){if(this._sound1){this._sound1.volume=this.fromSoundVolume*(1-progress)}if(this._sound2){this._sound2.volume=this.toSoundVolume*progress}}else{progress*=2;if(this._sound1){this._sound1.volume=Math.max(this.fromSoundVolume*(1-progress),0)}if(this._sound2){this._sound2.volume=Math.max(this.toSoundVolume*(progress-1),0)}}}}}module.exports=SoundMixer},{"./sound_instance.js":42}],44:[function(require,module,exports){"use strict";const IManager=require("./manager");const logger=require("./logger");const sfx=require("./sfx");const gfx=require("./gfx");const input=require("./input");const assets=require("./assets");const collision=require("./collision");const utils=require("./utils");const GameTime=require("./utils/game_time");let _usedManagers=null;let _prevUpdateTime=null;let _currFpsCounter=0;let _countSecond=0;let _currFps=0;let _startFrameTime=0;let _frameTimeMeasuresCount=0;let _totalFrameTimes=0;const version="1.3.2";class Shaku{constructor(){this.utils=utils;this.sfx=sfx;this.gfx=gfx;this.input=input;this.assets=assets;this.collision=collision}async init(managers){return new Promise(async(resolve,reject)=>{if(_usedManagers){throw new Error("Already initialized!")}GameTime.resetGameStartTime();_usedManagers=managers||[assets,sfx,gfx,input,collision];for(let i=0;i<_usedManagers.length;++i){await _usedManagers[i].setup()}_prevUpdateTime=new GameTime;resolve()})}destroy(){if(!_usedManagers){throw new Error("Not initialized!")}for(let i=0;i<_usedManagers.length;++i){_usedManagers[i].destroy()}}startFrame(){_startFrameTime=GameTime.rawTimestamp();this._gameTime=new GameTime(_prevUpdateTime);utils.Animator.updateAutos(this._gameTime.delta);for(let i=0;i<_usedManagers.length;++i){_usedManagers[i].startFrame()}}endFrame(){for(let i=0;i<_usedManagers.length;++i){_usedManagers[i].endFrame()}_prevUpdateTime=this._gameTime;_currFpsCounter++;_countSecond+=this._gameTime.delta;if(_countSecond>=1){_countSecond=0;_currFps=_currFpsCounter;_currFpsCounter=0;_totalFrameTimes=this.getAverageFrameTime();_frameTimeMeasuresCount=1}let _endFrameTime=GameTime.rawTimestamp();_frameTimeMeasuresCount++;_totalFrameTimes+=_endFrameTime-_startFrameTime}silent(){logger.silent()}throwErrorOnWarnings(enable){if(enable===undefined){throw Error("Must provide a value!")}logger.throwErrorOnWarnings(enable)}get gameTime(){return this._gameTime}get version(){return version}getFpsCount(){return _currFps}getAverageFrameTime(){if(_frameTimeMeasuresCount===0){return 0}return _totalFrameTimes/_frameTimeMeasuresCount}requestAnimationFrame(callback){if(window.requestAnimationFrame)return window.requestAnimationFrame(callback);else if(window.mozRequestAnimationFrame)return window.mozRequestAnimationFrame(callback);else if(window.webkitRequestAnimationFrame)return window.webkitRequestAnimationFrame(callback);else if(window.msRequestAnimationFrame)return window.msRequestAnimationFrame(callback);else return setTimeout(callback,1e3/60)}cancelAnimationFrame(id){if(window.cancelAnimationFrame)return window.cancelAnimationFrame(id);else if(window.mozCancelAnimationFrame)return window.mozCancelAnimationFrame(id);else clearTimeout(id)}}module.exports=new Shaku},{"./assets":5,"./collision":11,"./gfx":25,"./input":35,"./logger":38,"./manager":39,"./sfx":40,"./utils":49,"./utils/game_time":48}],45:[function(require,module,exports){"use strict";const _autoAnimators=[];class Animator{constructor(target){this._target=target;this._fromValues={};this._toValues={};this._progress=0;this._onFinish=null;this._smoothDamp=false;this._repeats=false;this._repeatsWithReverseAnimation=false;this._isInAutoUpdate=false;this._originalFrom=null;this._originalTo=null;this._originalRepeats=null;this.speedFactor=1}update(delta){if(this._progress>=1){return}delta*=this.speedFactor;this._progress+=delta;if(this._progress>=1){this._progress=1;if(this._onFinish){this._onFinish()}}for(let key in this._toValues){let keyParts=this._toValues[key].keyParts;let toValue=this._toValues[key].value;let fromValue=this._fromValues[key];if(fromValue===undefined){this._fromValues[key]=fromValue=this._getValueFromTarget(keyParts);if(fromValue===undefined){throw new Error(`Animator issue: missing origin value for key '${key}' and property not found in target object.`)}}let a=this._smoothDamp&&this._progress<1?this._progress*(1+1-this._progress):this._progress;let newValue=null;if(typeof fromValue==="number"){newValue=lerp(fromValue,toValue,a)}else if(fromValue.constructor.lerp){newValue=fromValue.constructor.lerp(fromValue,toValue,a)}else{throw new Error(`Animator issue: from-value for key '${key}' is not a number, and its class type don't implement a 'lerp()' method!`)}this._setValueToTarget(keyParts,newValue)}if(this._repeats&&this._progress>=1){if(typeof this._repeats==="number"){this._repeats--}this._progress=0;if(this._repeatsWithReverseAnimation){this.flipFromAndTo()}}}_getValueFromTarget(keyParts){if(keyParts.length===1){return this._target[keyParts[0]]}function index(obj,i){return obj[i]}return keyParts.reduce(index,this._target)}_setValueToTarget(keyParts,value){if(keyParts.length===1){this._target[keyParts[0]]=value;return}function index(obj,i){return obj[i]}let parent=keyParts.slice(0,keyParts.length-1).reduce(index,this._target);parent[keyParts[keyParts.length-1]]=value}_validateValueType(value){return typeof value==="number"||value&&value.constructor&&value.constructor.lerp}then(callback){this._onFinish=callback;return this}smoothDamp(enable){this._smoothDamp=enable;return this}repeats(enable,reverseAnimation){this._originalRepeats=this._repeats=enable;this._repeatsWithReverseAnimation=Boolean(reverseAnimation);return this}from(values){for(let key in values){if(!this._validateValueType(values[key])){throw new Error("Illegal value type to use with Animator! All values must be either numbers, or a class instance that has a static lerp() method.")}this._fromValues[key]=values[key]}this._originalFrom=null;return this}to(values){for(let key in values){if(!this._validateValueType(values[key])){throw new Error("Illegal value type to use with Animator! All values must be either numbers, or a class instance that has a static lerp() method.")}this._toValues[key]={keyParts:key.split("."),value:values[key]}}this._originalTo=null;return this}flipFromAndTo(){let newFrom={};let newTo={};if(!this._originalFrom){this._originalFrom=this._fromValues}if(!this._originalTo){this._originalTo=this._toValues}for(let key in this._toValues){newFrom[key]=this._toValues[key].value;newTo[key]={keyParts:key.split("."),value:this._fromValues[key]}}this._fromValues=newFrom;this._toValues=newTo}duration(seconds){this.speedFactor=1/seconds;return this}reset(){if(this._originalFrom){this._fromValues=this._originalFrom}if(this._originalTo){this._toValues=this._originalTo}if(this._originalRepeats!==null){this._repeats=this._originalRepeats}this._progress=0;return this}play(){if(this._isInAutoUpdate){return}_autoAnimators.push(this);this._isInAutoUpdate=true;return this}get ended(){return this._progress>=1}static updateAutos(delta){for(let i=_autoAnimators.length-1;i>=0;--i){_autoAnimators[i].update(delta);if(_autoAnimators[i].ended){_autoAnimators[i]._isInAutoUpdate=false;_autoAnimators.splice(i,1)}}}}function lerp(start,end,amt){return(1-amt)*start+amt*end}module.exports=Animator},{}],46:[function(require,module,exports){"use strict";const MathHelper=require("./math_helper");const Vector2=require("./vector2");class Circle{constructor(center,radius){this.center=center.clone();this.radius=radius}clone(){return new Circle(this.center,this.radius)}containsVector(p){return this.center.distanceTo(p)<=this.radius}equals(other){return other===this||other&&other.constructor===this.constructor&&this.center.equals(other.center)&&this.radius==other.radius}static lerp(p1,p2,a){let lerpScalar=MathHelper.lerp;return new Circle(Vector2.lerp(p1.center,p2.center,a),lerpScalar(p1.radius,p2.radius,a))}}module.exports=Circle},{"./math_helper":50,"./vector2":53}],47:[function(require,module,exports){"use strict";const MathHelper=require("./math_helper");class Color{constructor(r,g,b,a){this.set(r,g,b,a)}set(r,g,b,a){this._r=r;this._g=g;this._b=b;this._a=a===undefined?1:a;this._asHex=null;return this}setByte(r,g,b,a){this._r=r/255;this._g=g/255;this._b=b/255;this._a=a===undefined?1:a/255;this._asHex=null;return this}copy(other){this.set(other.r,other.g,other.b,other.a);return this}get r(){return this._r}get g(){return this._g}get b(){return this._b}get a(){return this._a}set r(val){this._r=val;this._asHex=null;return this._r}set g(val){this._g=val;this._asHex=null;return this._g}set b(val){this._b=val;this._asHex=null;return this._b}set a(val){this._a=val;this._asHex=null;return this._a}static componentToHex(c){var hex=Math.round(c).toString(16);return hex.length==1?"0"+hex:hex}get asHex(){if(!this._asHex){this._asHex="#"+Color.componentToHex(this.r*255)+Color.componentToHex(this.g*255)+Color.componentToHex(this.b*255)+Color.componentToHex(this.a*255)}return this._asHex}static fromHex(val){if(typeof val!=="string"&&val[0]!="#"){throw new PintarJS.Error("Invalid color format!")}var parsed=hexToColor(val);if(!parsed){throw new Error("Invalid hex value to parse!")}return new Color(parsed.r,parsed.g,parsed.b,1)}static fromDecimal(val,includeAlpha){let ret=new Color(1,1,1,1);if(includeAlpha){ret.a=(val&255)/255;val=val>>8}ret.b=(val&255)/255;val=val>>8;ret.g=(val&255)/255;val=val>>8;ret.r=(val&255)/255}get asDecimalRGBA(){return(Math.round(this.r*255)<<8*3|Math.round(this.g*255)<<8*2|Math.round(this.b*255)<<8*1|Math.round(this.a*255))>>>0}get asDecimalABGR(){return(Math.round(this.a*255)<<8*3|Math.round(this.b*255)<<8*2|Math.round(this.g*255)<<8*1|Math.round(this.r*255))>>>0}get floatArray(){return[this.r,this.g,this.b,this.a]}clone(){return new Color(this.r,this.g,this.b,this.a)}string(){return this.r+","+this.g+","+this.b+","+this.a}get isBlack(){return this.r==0&&this.g==0&&this.b==0}static random(includeAlpha){return new Color(Math.random(),Math.random(),Math.random(),includeAlpha?Math.random():1)}static fromBytesArray(bytes){return new Color(bytes[0]/255,bytes[1]/255,bytes[2]/255,bytes[3]/255||1)}get isTransparentBlack(){return this._r==this._g&&this._g==this._b&&this._b==this._a&&this._a==0}static get webColorNames(){return colorKeys}equals(other){return this===other||other&&other.constructor===this.constructor&&this._r==other._r&&this._g==other._g&&this._b==other._b&&this._a==other._a}static lerp(p1,p2,a){let lerpScalar=MathHelper.lerp;return new Color(lerpScalar(p1.r,p2.r,a),lerpScalar(p1.g,p2.g,a),lerpScalar(p1.b,p2.b,a),lerpScalar(p1.a,p2.a,a))}}const colorNameToHex={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};for(var key in colorNameToHex){if(colorNameToHex.hasOwnProperty(key)){var colorValue=hexToColor(colorNameToHex[key]);(function(_colValue){Object.defineProperty(Color,key,{get:function(){return _colValue.clone()}})})(colorValue)}}const colorKeys=Object.keys(colorNameToHex);Object.freeze(colorKeys);Object.defineProperty(Color,"transparent",{get:function(){return new Color(0,0,0,0)}});Object.defineProperty(Color,"transwhite",{get:function(){return new Color(1,1,1,0)}});function hexToColor(hex){var shorthandRegex=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;hex=hex.replace(shorthandRegex,function(m,r,g,b){return r+r+g+g+b+b});var result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);var components=result?{r:parseInt(result[1],16)/255,g:parseInt(result[2],16)/255,b:parseInt(result[3],16)/255}:null;if(!components){throw new PintarConsole.Error("Invalid hex value to parse!")}return new Color(components.r,components.g,components.b,1)}module.exports=Color},{"./math_helper":50}],48:[function(require,module,exports){"use strict";class GameTime{constructor(prevTime){this.timestamp=getAccurateTimestampMs()-_startTime;this.elapsedTime={milliseconds:this.timestamp-_startGameTime,seconds:(this.timestamp-_startGameTime)/1e3};if(prevTime){this.deltaTime={milliseconds:this.timestamp-prevTime.timestamp,seconds:(this.timestamp-prevTime.timestamp)/1e3}}else{this.deltaTime=null}this.delta=this.deltaTime?this.deltaTime.seconds:null;this.elapsed=this.elapsedTime.seconds;Object.freeze(this)}}const gotPerformance=typeof performance!=="undefined"&&performance.now;function getAccurateTimestampMs(){if(gotPerformance){return performance.now()}return Date.now()}const _startTime=getAccurateTimestampMs();var _startGameTime=getAccurateTimestampMs();GameTime.resetGameStartTime=(()=>{_startGameTime=getAccurateTimestampMs()});GameTime.rawTimestamp=getAccurateTimestampMs;module.exports=GameTime},{}],49:[function(require,module,exports){"use strict";module.exports={Vector2:require("./vector2"),Rectangle:require("./rectangle"),Circle:require("./circle"),Color:require("./color"),Animator:require("./animator"),GameTime:require("./game_time"),MathHelper:require("./math_helper"),SeededRandom:require("./seeded_random")}},{"./animator":45,"./circle":46,"./color":47,"./game_time":48,"./math_helper":50,"./rectangle":51,"./seeded_random":52,"./vector2":53}],50:[function(require,module,exports){"use strict";const _toRadsFactor=Math.PI/180;const _toDegreesFactor=180/Math.PI;class MathHelper{static lerp(start,end,amount){return(1-amount)*start+amount*end}static toRadians(degrees){return degrees*_toRadsFactor}static toDegrees(radians){return radians*_toDegreesFactor}static radiansDistance(a1,a2){var max=Math.PI*2;var da=(a2-a1)%max;return 2*da%max-da}static lerpRadians(a1,a2,alpha){return a1+this.radiansDistance(a1,a2)*alpha}static lerpDegrees(a1,a2,alpha){a1=this.toRadians(a1);a2=this.toRadians(a2);var ret=this.lerpRadians(a1,a2,alpha);return this.toDegrees(ret)}static round10(num){return Math.round(num*1e8)/1e8}}MathHelper.PI2=Math.PI*2;module.exports=MathHelper},{}],51:[function(require,module,exports){"use strict";const Circle=require("./circle");const MathHelper=require("./math_helper");const Vector2=require("./vector2");class Rectangle{constructor(x,y,width,height){this.x=x||0;this.y=y||0;this.width=width;this.height=height}set(x,y,width,height){this.x=x;this.y=y;this.width=width;this.height=height;return this}getPosition(){return new Vector2(this.x,this.y)}getSize(){return new Vector2(this.width,this.height)}getCenter(){return new Vector2(Math.round(this.x+this.width/2),Math.round(this.y+this.height/2))}get left(){return this.x}get right(){return this.x+this.width}get top(){return this.y}get bottom(){return this.y+this.height}clone(){return new Rectangle(this.x,this.y,this.width,this.height)}getTopLeft(){return new Vector2(this.x,this.y)}getTopRight(){return new Vector2(this.x+this.width,this.y)}getBottomLeft(){return new Vector2(this.x,this.y+this.height)}getBottomRight(){return new Vector2(this.x+this.width,this.y+this.height)}string(){return this.x+","+this.y+","+this.width+","+this.height}containsVector(p){return p.x>=this.x&&p.x<=this.x+this.width&&p.y>=this.y&&p.y<=this.y+this.height}collideRect(other){let r1=this;let r2=other;return!(r2.left>=r1.right||r2.right<=r1.left||r2.top>=r1.bottom||r2.bottom<=r1.top)}collideCircle(circle){let center=circle.center;let radius=circle.radius;let rect=this;if(rect.containsVector(center)){return true}let rectCenter=rect.getCenter();let topLeft=rect.getTopLeft();let topRight=rect.getTopRight();let bottomRight=rect.getBottomRight();let bottomLeft=rect.getBottomLeft();let lines=[];if(rectCenter.x>center.x){lines.push([topLeft,bottomLeft])}else{lines.push([topRight,bottomRight])}if(rectCenter.y>center.y){lines.push([topLeft,topRight])}else{lines.push([bottomLeft,bottomRight])}for(let i=0;i<lines.length;++i){let disToLine=pointLineDistance(center,lines[i][0],lines[i][1]);if(disToLine<=radius){return true}}return false}static fromPoints(points){let min_x=points[0].x;let min_y=points[0].y;let max_x=min_x;let max_y=min_y;for(let i=1;i<points.length;++i){min_x=Math.min(min_x,points[i].x);min_y=Math.min(min_y,points[i].y);max_x=Math.max(max_x,points[i].x);max_y=Math.max(max_y,points[i].y)}return new Rectangle(min_x,min_y,max_x-min_x,max_y-min_y)}equals(other){return this===other||other&&other.constructor===this.constructor&&this.x==other.x&&this.y==other.y&&this.width==other.width&&this.height==other.height}static lerp(p1,p2,a){let lerpScalar=MathHelper.lerp;return new Rectangle(lerpScalar(p1.x,p2.x,a),lerpScalar(p1.y,p2.y,a),lerpScalar(p1.width,p2.width,a),lerpScalar(p1.height,p2.height,a))}}function pointLineDistance(p1,l1,l2){let x=p1.x;let y=p1.y;let x1=l1.x;let y1=l1.y;let x2=l2.x;let y2=l2.y;var A=x-x1;var B=y-y1;var C=x2-x1;var D=y2-y1;var dot=A*C+B*D;var len_sq=C*C+D*D;var param=-1;if(len_sq!=0)param=dot/len_sq;var xx,yy;if(param<0){xx=x1;yy=y1}else if(param>1){xx=x2;yy=y2}else{xx=x1+param*C;yy=y1+param*D}var dx=x-xx;var dy=y-yy;return Math.sqrt(dx*dx+dy*dy)}module.exports=Rectangle},{"./circle":46,"./math_helper":50,"./vector2":53}],52:[function(require,module,exports){"use strict";class SeededRandom{constructor(seed){if(seed===undefined){seed=0}this.seed=seed}random(min,max){this.seed=(this.seed*9301+49297)%233280;let rnd=this.seed/233280;if(min&&max){return min+rnd*(max-min)}else if(min){return rnd*min}return rnd}pick(options){return options[Math.floor(this.random(options.length))]}}module.exports=SeededRandom},{}],53:[function(require,module,exports){"use strict";const MathHelper=require("./math_helper");class Vector2{constructor(x=0,y=0){this.x=x;this.y=y}clone(){return new Vector2(this.x,this.y)}set(x,y){this.x=x;this.y=y;return this}copy(other){this.x=other.x;this.y=other.y;return this}add(other){if(typeof other==="number"){return new Vector2(this.x+other,this.y+(arguments[1]===undefined?other:arguments[1]))}return new Vector2(this.x+other.x,this.y+other.y)}sub(other){if(typeof other==="number"){return new Vector2(this.x-other,this.y-(arguments[1]===undefined?other:arguments[1]))}return new Vector2(this.x-other.x,this.y-other.y)}div(other){if(typeof other==="number"){return new Vector2(this.x/other,this.y/(arguments[1]===undefined?other:arguments[1]))}return new Vector2(this.x/other.x,this.y/other.y)}mul(other){if(typeof other==="number"){return new Vector2(this.x*other,this.y*(arguments[1]===undefined?other:arguments[1]))}return new Vector2(this.x*other.x,this.y*other.y)}round(){return new Vector2(Math.round(this.x),Math.round(this.y))}floor(){return new Vector2(Math.floor(this.x),Math.floor(this.y))}ceil(){return new Vector2(Math.ceil(this.x),Math.ceil(this.y))}normalized(){if(this.x==0&&this.y==0){return Vector2.zero()}let mag=this.length;return new Vector2(this.x/mag,this.y/mag)}addSelf(other){if(typeof other==="number"){this.x+=other;this.y+=arguments[1]===undefined?other:arguments[1]}else{this.x+=other.x;this.y+=other.y}return this}subSelf(other){if(typeof other==="number"){this.x-=other;this.y-=arguments[1]===undefined?other:arguments[1]}else{this.x-=other.x;this.y-=other.y}return this}divSelf(other){if(typeof other==="number"){this.x/=other;this.y/=arguments[1]===undefined?other:arguments[1]}else{this.x/=other.x;this.y/=other.y}return this}mulSelf(other){if(typeof other==="number"){this.x*=other;this.y*=arguments[1]===undefined?other:arguments[1]}else{this.x*=other.x;this.y*=other.y}return this}roundSelf(){this.x=Math.round(this.x);this.y=Math.round(this.y);return this}floorSelf(){this.x=Math.floor(this.x);this.y=Math.floor(this.y);return this}ceilSelf(){this.x=Math.ceil(this.x);this.y=Math.ceil(this.y);return this}normalizeSelf(){if(this.x==0&&this.y==0){return this}let mag=this.length;this.x/=mag;this.y/=mag;return this}equals(other){return this===other||other.constructor===this.constructor&&this.x===other.x&&this.y===other.y}approximate(other){return this===other||Math.abs(this.x-other.x)<=1&&Math.abs(this.y-other.y)<=1}get length(){return Math.sqrt(this.x*this.x+this.y*this.y)}scaled(fac){return new Vector2(this.x*fac,this.y*fac)}static get zero(){return new Vector2}static get one(){return new Vector2(1,1)}static get half(){return new Vector2(.5,.5)}static get left(){return new Vector2(-1,0)}static get right(){return new Vector2(1,0)}static get up(){return new Vector2(0,-1)}static get down(){return new Vector2(0,1)}degreesTo(other){return Vector2.degreesBetween(this,other)}radiansTo(other){return Vector2.radiansBetween(this,other)}distanceTo(other){return Vector2.distance(this,other)}static fromDegree(degrees){let rads=degrees*(Math.PI/180);return new Vector2(Math.cos(rads),Math.sin(rads))}static fromRadians(radians){return new Vector2(Math.cos(radians),Math.sin(radians))}static lerp(p1,p2,a){let lerpScalar=MathHelper.lerp;return new Vector2(lerpScalar(p1.x,p2.x,a),lerpScalar(p1.y,p2.y,a))}static degreesBetween(P1,P2){let deltaY=P2.y-P1.y,deltaX=P2.x-P1.x;return Math.atan2(deltaY,deltaX)*(180/Math.PI)}static radiansBetween(P1,P2){let deltaY=P2.y-P1.y,deltaX=P2.x-P1.x;return Math.atan2(deltaY,deltaX)}static distance(p1,p2){let a=p1.x-p2.x;let b=p1.y-p2.y;return Math.sqrt(a*a+b*b)}static cross(p1,p2){return p1.x*p2.y-p1.y*p2.x}static dot(p1,p2){return p1.x*p2.x+p1.y*p2.y}string(){return this.x+","+this.y}static parse(str){let parts=str.split(",");return new Vector2(parseFloat(parts[0].trim()),parseFloat(parts[1].trim()))}}module.exports=Vector2},{"./math_helper":50}]},{},[34])(34)});